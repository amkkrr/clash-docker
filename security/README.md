# Clash Docker 安全配置

## 概述

本目录包含Clash Docker项目的企业级安全配置和加固措施，实现了多层防护和最小权限原则。

## 安全组件

### 1. 安全加固的Docker Compose
- **文件**: `compose.secure.yml`
- **功能**: 使用非root用户、只读文件系统、资源限制、安全选项
- **特性**:
  - 所有容器使用非root用户运行
  - 实施最小权限原则 (cap_drop: ALL)
  - 只读根文件系统保护
  - 内存和CPU资源限制
  - 网络隔离和安全标签

### 2. 安全扫描工具
- **文件**: `docker-security-scan.sh`
- **功能**: 自动化安全漏洞扫描和配置检查
- **检查项目**:
  - 镜像漏洞扫描 (Docker Scout)
  - 容器安全配置验证
  - 网络安全检查
  - 文件权限验证
  - 端口安全分析

### 3. Nginx 安全配置
- **文件**: `nginx-security.conf`
- **功能**: 企业级Web服务器安全加固
- **安全特性**:
  - 全面的安全头设置
  - 限流和DDoS防护
  - IP白名单和地理位置限制
  - 恶意请求检测和阻断
  - 基本认证和访问控制

### 4. 安全加固的Dockerfile
- **文件**: `Dockerfile.clash`
- **功能**: 基于最佳实践的容器镜像构建
- **特性**:
  - 非root用户运行
  - 最小化攻击面
  - 健康检查集成
  - 安全的目录权限

### 5. 认证配置
- **文件**: `htpasswd`
- **功能**: Nginx基本认证用户管理
- **默认账户**:
  - 管理员: `admin / clashsecure123`
  - 管理员备用: `manager / manager456`

## 安全标准和合规性

### 安全级别
- **等级**: 高 (High)
- **合规性**: 企业级要求
- **认证**: 基本认证 + IP白名单

### 实施的安全控制

1. **身份验证和授权**
   - HTTP基本认证
   - IP地址白名单
   - 用户角色分离

2. **网络安全**
   - 端口绑定到localhost
   - 网络隔离 (容器间通信禁用)
   - 限流和连接限制

3. **容器安全**
   - 非特权用户运行
   - 只读文件系统
   - 能力限制 (Linux capabilities)
   - 资源限制

4. **数据保护**
   - 敏感配置加密
   - 文件权限控制
   - 日志安全

5. **监控和审计**
   - 安全事件日志
   - 定期安全扫描
   - 健康状态监控

## 使用指南

### 启动安全版本
```bash
# 使用安全加固的配置启动
docker compose -f security/compose.secure.yml up -d

# 运行安全扫描
./security/docker-security-scan.sh
```

### 访问控制
```bash
# 访问管理界面 (需要认证)
curl -u admin:clashsecure123 http://localhost:8088/dashboard/

# 访问配置文件 (需要IP白名单)
curl http://localhost:8088/config.yaml
```

### 安全监控
```bash
# 查看安全日志
tail -f logs/security-monitor.log

# 检查扫描结果
ls -la security/scan-results/
```

## 安全配置参数

### 网络安全参数
- **连接限制**: 每IP 10个连接
- **请求限制**: 每IP每秒5个请求
- **超时设置**: 10秒连接超时

### 容器安全参数
- **用户ID**: 非root (1000+)
- **文件系统**: 只读根 + 可写临时目录
- **内存限制**: 128M-512M
- **CPU限制**: 0.1-1.0核心

### 认证参数
- **认证方式**: HTTP Basic
- **密码加密**: bcrypt (cost=10)
- **会话管理**: 无状态

## 安全最佳实践

1. **定期更新密码**
   ```bash
   # 生成新密码哈希
   htpasswd -B -C 10 security/htpasswd admin
   ```

2. **监控安全日志**
   ```bash
   # 监控访问日志
   tail -f logs/nginx-access.log | grep -E "(40[0-9]|50[0-9])"
   ```

3. **定期安全扫描**
   ```bash
   # 运行完整安全检查
   ./security/docker-security-scan.sh
   ```

4. **更新IP白名单**
   - 编辑 `nginx-security.conf` 中的 `geo $whitelist` 配置
   - 重启nginx容器应用更改

## 故障排除

### 常见问题

1. **403 Forbidden 错误**
   - 检查IP是否在白名单中
   - 验证认证凭据

2. **容器权限错误**
   - 确认文件权限设置正确
   - 检查用户ID映射

3. **网络连接问题**
   - 验证端口绑定配置
   - 检查防火墙设置

### 安全事件响应

1. **发现安全漏洞**
   - 立即隔离受影响容器
   - 分析安全日志
   - 应用安全补丁

2. **异常访问检测**
   - 检查访问日志
   - 更新IP黑名单
   - 强化认证要求

## 维护计划

- **每日**: 自动安全扫描
- **每周**: 日志分析和清理
- **每月**: 密码轮换和配置审核
- **季度**: 全面安全评估

## 联系信息

如有安全问题或建议，请联系系统管理员。

---
*最后更新: 2025-07-12*
*安全级别: HIGH*
*版本: 1.0*