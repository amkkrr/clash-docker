# ğŸ” å®‰å…¨é…ç½®æŒ‡å—

## ğŸ“š ç›®å½•

1. [å®‰å…¨æ¶æ„æ¦‚è¿°](#å®‰å…¨æ¶æ„æ¦‚è¿°)
2. [å®¹å™¨å®‰å…¨é…ç½®](#å®¹å™¨å®‰å…¨é…ç½®)
3. [ç½‘ç»œå®‰å…¨ç­–ç•¥](#ç½‘ç»œå®‰å…¨ç­–ç•¥)
4. [è®¿é—®æ§åˆ¶å’Œè®¤è¯](#è®¿é—®æ§åˆ¶å’Œè®¤è¯)
5. [æ•°æ®ä¿æŠ¤å’ŒåŠ å¯†](#æ•°æ®ä¿æŠ¤å’ŒåŠ å¯†)
6. [å®‰å…¨ç›‘æ§å’Œå®¡è®¡](#å®‰å…¨ç›‘æ§å’Œå®¡è®¡)
7. [å®‰å…¨æ‰«æå’Œæ£€æµ‹](#å®‰å…¨æ‰«æå’Œæ£€æµ‹)
8. [äº‹ä»¶å“åº”å’Œæ¢å¤](#äº‹ä»¶å“åº”å’Œæ¢å¤)
9. [åˆè§„æ€§è¦æ±‚](#åˆè§„æ€§è¦æ±‚)
10. [å®‰å…¨æœ€ä½³å®è·µ](#å®‰å…¨æœ€ä½³å®è·µ)

---

## å®‰å…¨æ¶æ„æ¦‚è¿°

### å¤šå±‚é˜²æŠ¤æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        å¤–éƒ¨ç½‘ç»œè¾¹ç•Œ                    â”‚
â”‚    (é˜²ç«å¢™ + DDoSé˜²æŠ¤)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åº”ç”¨å±‚å®‰å…¨                    â”‚
â”‚   (HTTPS + è®¤è¯ + è®¿é—®æ§åˆ¶)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å®¹å™¨å®‰å…¨å±‚                    â”‚
â”‚  (érootè¿è¡Œ + èµ„æºé™åˆ¶ + éš”ç¦»)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä¸»æœºå®‰å…¨å±‚                    â”‚
â”‚    (å†…æ ¸åŠ å›º + å®¡è®¡ + ç›‘æ§)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®‰å…¨åŸåˆ™

- **æœ€å°æƒé™åŸåˆ™**: åªæˆäºˆå®Œæˆä»»åŠ¡æ‰€éœ€çš„æœ€å°æƒé™
- **æ·±åº¦é˜²æŠ¤**: å¤šå±‚å®‰å…¨æ§åˆ¶ï¼Œé˜²æ­¢å•ç‚¹å¤±æ•ˆ
- **é»˜è®¤æ‹’ç»**: é»˜è®¤ç¦æ­¢æ‰€æœ‰è®¿é—®ï¼Œæ˜ç¡®å…è®¸å¿…è¦çš„è®¿é—®
- **æŒç»­ç›‘æ§**: å®æ—¶ç›‘æ§å’Œå®¡è®¡æ‰€æœ‰æ´»åŠ¨
- **å¿«é€Ÿå“åº”**: å»ºç«‹å®Œå–„çš„äº‹ä»¶å“åº”æœºåˆ¶

## å®¹å™¨å®‰å…¨é…ç½®

### å®‰å…¨çš„Dockerfile

åˆ›å»º `security/Dockerfile.clash-secure`:
```dockerfile
# ä½¿ç”¨å®˜æ–¹æœ€å°é•œåƒ
FROM alpine:3.18 as builder

# å®‰å…¨å‚æ•°
ARG BUILD_DATE
ARG VERSION
ARG VCS_REF

# æ ‡ç­¾ä¿¡æ¯
LABEL org.opencontainers.image.created=$BUILD_DATE \
      org.opencontainers.image.title="Clash Secure" \
      org.opencontainers.image.version=$VERSION \
      org.opencontainers.image.revision=$VCS_REF \
      org.opencontainers.image.vendor="Clash Docker Team" \
      org.opencontainers.image.licenses="MIT"

# å®‰è£…å®‰å…¨å·¥å…·å’Œä¾èµ–
RUN apk add --no-cache \
    ca-certificates \
    tzdata \
    curl \
    && update-ca-certificates

# ä¸‹è½½å’ŒéªŒè¯ClashäºŒè¿›åˆ¶æ–‡ä»¶
ARG CLASH_VERSION=v1.18.0
ARG TARGETARCH
RUN CLASH_URL="https://github.com/Dreamacro/clash/releases/download/${CLASH_VERSION}/clash-linux-${TARGETARCH}-${CLASH_VERSION}.gz" && \
    CLASH_CHECKSUM_URL="https://github.com/Dreamacro/clash/releases/download/${CLASH_VERSION}/clash-linux-${TARGETARCH}-${CLASH_VERSION}.gz.sha256" && \
    curl -L "$CLASH_URL" -o clash.gz && \
    curl -L "$CLASH_CHECKSUM_URL" -o clash.gz.sha256 && \
    sha256sum -c clash.gz.sha256 && \
    gunzip clash.gz && \
    chmod +x clash

# è¿è¡Œæ—¶é•œåƒ
FROM alpine:3.18

# åˆ›å»ºéç‰¹æƒç”¨æˆ·
RUN addgroup -g 1000 clash && \
    adduser -D -s /bin/sh -u 1000 -G clash clash

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    ca-certificates \
    tzdata \
    curl \
    tini \
    && rm -rf /var/cache/apk/*

# å¤åˆ¶æ–‡ä»¶
COPY --from=builder clash /usr/local/bin/clash
COPY --chown=clash:clash config/clash-template.yaml /app/config/

# åˆ›å»ºç›®å½•å’Œè®¾ç½®æƒé™
RUN mkdir -p /app/{config,data,logs} && \
    chown -R clash:clash /app && \
    chmod -R 750 /app

# å®‰å…¨é…ç½®
RUN chmod +x /usr/local/bin/clash

# åˆ‡æ¢åˆ°éç‰¹æƒç”¨æˆ·
USER clash
WORKDIR /app

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:9090/version || exit 1

# æš´éœ²ç«¯å£ (ä»…ç›‘å¬localhost)
EXPOSE 7890 7891 9090

# ä½¿ç”¨tiniä½œä¸ºinitè¿›ç¨‹
ENTRYPOINT ["/sbin/tini", "--"]
CMD ["clash", "-d", "/app/config"]
```

### å®‰å…¨çš„Docker Composeé…ç½®

åˆ›å»º `security/compose.secure.yml`:
```yaml
version: '3.8'

x-security-defaults: &security-defaults
  # å®‰å…¨é€‰é¡¹
  security_opt:
    - no-new-privileges:true
    - apparmor:docker-default
    - seccomp:default
  
  # ç§»é™¤æ‰€æœ‰capabilities
  cap_drop:
    - ALL
  
  # ç”¨æˆ·å’Œç»„
  user: "1000:1000"
  
  # åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
  read_only: true
  
  # ç¦ç”¨ç‰¹æƒæ¨¡å¼
  privileged: false
  
  # å†…å­˜é™åˆ¶é˜²æ­¢DoS
  mem_limit: 512m
  mem_reservation: 256m
  
  # CPUé™åˆ¶
  cpus: 1.0
  
  # é‡å¯ç­–ç•¥
  restart: unless-stopped

services:
  clash:
    <<: *security-defaults
    build:
      context: .
      dockerfile: security/Dockerfile.clash-secure
      args:
        BUILD_DATE: ${BUILD_DATE:-}
        VERSION: ${VERSION:-latest}
        VCS_REF: ${VCS_REF:-}
    
    # ç½‘ç»œå®‰å…¨
    networks:
      - clash-internal
    
    # ç«¯å£ç»‘å®šåˆ°localhost
    ports:
      - "127.0.0.1:7890:7890"
      - "127.0.0.1:7891:7891"
      - "127.0.0.1:9090:9090"
    
    # å®‰å…¨çš„æŒ‚è½½
    volumes:
      - ./config:/app/config:ro,noexec,nosuid,nodev
      - clash-data:/app/data:rw,noexec,nosuid,nodev
      - clash-logs:/app/logs:rw,noexec,nosuid,nodev
    
    # ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=100m
      - /var/tmp:noexec,nosuid,nodev,size=50m
    
    # ç¯å¢ƒå˜é‡ï¼ˆéæ•æ„Ÿï¼‰
    environment:
      - TZ=UTC
      - CLASH_LOG_LEVEL=${CLASH_LOG_LEVEL:-info}
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    
    # é¢å¤–çš„å®‰å…¨capabilitiesï¼ˆæœ€å°åŒ–ï¼‰
    cap_add:
      - NET_BIND_SERVICE  # ä»…ç»‘å®šç«¯å£éœ€è¦

  nginx:
    <<: *security-defaults
    build:
      context: .
      dockerfile: security/Dockerfile.nginx-secure
    
    networks:
      - clash-internal
      - web-external
    
    ports:
      - "8088:8088"
    
    volumes:
      - ./security/nginx-security.conf:/etc/nginx/nginx.conf:ro
      - ./security/htpasswd:/etc/nginx/htpasswd:ro
      - ./html:/var/www/html:ro,noexec,nosuid,nodev
      - nginx-cache:/var/cache/nginx:rw,noexec,nosuid,nodev
      - nginx-logs:/var/log/nginx:rw,noexec,nosuid,nodev
    
    tmpfs:
      - /var/run:noexec,nosuid,nodev,size=10m
      - /tmp:noexec,nosuid,nodev,size=50m
    
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETGID
      - SETUID
    
    mem_limit: 256m
    cpus: 0.5

  # å®‰å…¨æ‰«ææœåŠ¡ (å¯é€‰)
  security-scanner:
    image: aquasec/trivy:latest
    restart: "no"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./security/scan-results:/results:rw
    command: image --format json --output /results/scan-report.json clash-docker_clash
    profiles:
      - security-scan

networks:
  clash-internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.20.0.0/24
  
  web-external:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24

volumes:
  clash-data:
    driver: local
    driver_opts:
      type: none
      o: bind,noexec,nosuid,nodev
      device: ./data
  
  clash-logs:
    driver: local
    driver_opts:
      type: none
      o: bind,noexec,nosuid,nodev
      device: ./logs
  
  nginx-cache:
    driver: local
  
  nginx-logs:
    driver: local
```

### å®¹å™¨å®‰å…¨æ‰«æ

åˆ›å»º `security/scan-containers.sh`:
```bash
#!/bin/bash
# å®¹å™¨å®‰å…¨æ‰«æè„šæœ¬

set -euo pipefail

SCAN_DIR="./security/scan-results"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

mkdir -p "$SCAN_DIR"

# Trivyæ‰«æ
scan_with_trivy() {
    echo "ä½¿ç”¨Trivyè¿›è¡Œå®‰å…¨æ‰«æ..."
    
    local images=("clash-docker_clash" "clash-docker_nginx")
    
    for image in "${images[@]}"; do
        echo "æ‰«æé•œåƒ: $image"
        
        # æ¼æ´æ‰«æ
        trivy image \
            --format json \
            --output "$SCAN_DIR/${image}_vulnerabilities_$TIMESTAMP.json" \
            "$image"
        
        # é…ç½®æ‰«æ
        trivy image \
            --security-checks config \
            --format json \
            --output "$SCAN_DIR/${image}_config_$TIMESTAMP.json" \
            "$image"
        
        # ç”ŸæˆHTMLæŠ¥å‘Š
        trivy image \
            --format template \
            --template '@contrib/html.tpl' \
            --output "$SCAN_DIR/${image}_report_$TIMESTAMP.html" \
            "$image"
    done
}

# Docker Benchå®‰å…¨æ£€æŸ¥
run_docker_bench() {
    echo "è¿è¡ŒDocker Benchå®‰å…¨æ£€æŸ¥..."
    
    docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v /etc:/etc:ro \
        -v /usr/bin/docker:/usr/bin/docker:ro \
        --label docker_bench_security \
        docker/docker-bench-security > "$SCAN_DIR/docker_bench_$TIMESTAMP.txt"
}

# è‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥
custom_security_checks() {
    echo "æ‰§è¡Œè‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥..."
    
    local report="$SCAN_DIR/custom_security_$TIMESTAMP.txt"
    
    {
        echo "=== è‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥æŠ¥å‘Š ==="
        echo "æ—¶é—´: $(date)"
        echo ""
        
        echo "=== å®¹å™¨è¿è¡Œç”¨æˆ·æ£€æŸ¥ ==="
        docker compose exec -T clash whoami
        docker compose exec -T nginx whoami
        echo ""
        
        echo "=== ç«¯å£ç»‘å®šæ£€æŸ¥ ==="
        netstat -tlnp | grep -E ':(7890|7891|8088|9090)'
        echo ""
        
        echo "=== æ–‡ä»¶æƒé™æ£€æŸ¥ ==="
        ls -la config/
        echo ""
        
        echo "=== å®¹å™¨Capabilitiesæ£€æŸ¥ ==="
        docker inspect clash-docker_clash_1 | jq '.[0].HostConfig.CapAdd'
        docker inspect clash-docker_clash_1 | jq '.[0].HostConfig.CapDrop'
        echo ""
        
        echo "=== èµ„æºé™åˆ¶æ£€æŸ¥ ==="
        docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"
        
    } > "$report"
    
    echo "è‡ªå®šä¹‰æ£€æŸ¥å®Œæˆ: $report"
}

# ç”Ÿæˆå®‰å…¨è¯„ä¼°æŠ¥å‘Š
generate_security_report() {
    echo "ç”Ÿæˆå®‰å…¨è¯„ä¼°æŠ¥å‘Š..."
    
    local report="$SCAN_DIR/security_assessment_$TIMESTAMP.md"
    
    cat > "$report" << EOF
# å®‰å…¨è¯„ä¼°æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: $(date)
**æ‰«æèŒƒå›´**: Clash Docker åº”ç”¨æ ˆ

## æ‰«æç»“æœæ‘˜è¦

### é•œåƒæ¼æ´æ‰«æ
$(find "$SCAN_DIR" -name "*vulnerabilities_$TIMESTAMP.json" -exec echo "- {}" \;)

### é…ç½®å®‰å…¨æ£€æŸ¥
$(find "$SCAN_DIR" -name "*config_$TIMESTAMP.json" -exec echo "- {}" \;)

### Docker Benchæ£€æŸ¥
- docker_bench_$TIMESTAMP.txt

### è‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥
- custom_security_$TIMESTAMP.txt

## é£é™©è¯„ä¼°

### é«˜é£é™©é—®é¢˜
$(grep -l "HIGH\|CRITICAL" "$SCAN_DIR"/*_$TIMESTAMP.* | head -5 || echo "æ— é«˜é£é™©é—®é¢˜å‘ç°")

### ä¸­é£é™©é—®é¢˜
$(grep -l "MEDIUM" "$SCAN_DIR"/*_$TIMESTAMP.* | head -5 || echo "æ— ä¸­é£é™©é—®é¢˜å‘ç°")

## ä¿®å¤å»ºè®®

1. å®šæœŸæ›´æ–°åŸºç¡€é•œåƒ
2. åº”ç”¨å®‰å…¨è¡¥ä¸
3. æ£€æŸ¥é…ç½®æ–‡ä»¶æƒé™
4. ç›‘æ§è¿è¡Œæ—¶å¼‚å¸¸

## ä¸‹æ¬¡æ‰«æè®¡åˆ’

å»ºè®®æ¯å‘¨è¿›è¡Œä¸€æ¬¡å®‰å…¨æ‰«æï¼Œæˆ–åœ¨ç‰ˆæœ¬æ›´æ–°åç«‹å³æ‰«æã€‚

---
**æŠ¥å‘Šç”Ÿæˆå·¥å…·**: Clash Docker å®‰å…¨æ‰«æå·¥å…·
**ç‰ˆæœ¬**: 1.0.0
EOF

    echo "å®‰å…¨è¯„ä¼°æŠ¥å‘Šç”Ÿæˆå®Œæˆ: $report"
}

# ä¸»æ‰«ææµç¨‹
main() {
    echo "å¼€å§‹å®‰å…¨æ‰«æ - $TIMESTAMP"
    
    scan_with_trivy
    run_docker_bench
    custom_security_checks
    generate_security_report
    
    echo "å®‰å…¨æ‰«æå®Œæˆ - $TIMESTAMP"
    echo "æ‰«æç»“æœä¿å­˜åœ¨: $SCAN_DIR"
}

main "$@"
```

## ç½‘ç»œå®‰å…¨ç­–ç•¥

### é˜²ç«å¢™é…ç½®

#### iptablesè§„åˆ™

åˆ›å»º `security/firewall-rules.sh`:
```bash
#!/bin/bash
# é˜²ç«å¢™è§„åˆ™é…ç½®

set -euo pipefail

# æ¸…é™¤ç°æœ‰è§„åˆ™
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X

# è®¾ç½®é»˜è®¤ç­–ç•¥
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# å…è®¸loopback
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# å…è®¸å·²å»ºç«‹çš„è¿æ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# SSHè®¿é—® (é™åˆ¶æºIP)
iptables -A INPUT -p tcp --dport 22 -s 10.0.0.0/8 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -s 172.16.0.0/12 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -s 192.168.0.0/16 -j ACCEPT

# WebæœåŠ¡ç«¯å£
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
iptables -A INPUT -p tcp --dport 8088 -j ACCEPT

# é™åˆ¶å¹¶å‘è¿æ¥æ•°
iptables -A INPUT -p tcp --dport 8088 -m connlimit --connlimit-above 100 -j REJECT

# DDoSé˜²æŠ¤
iptables -A INPUT -p tcp --dport 8088 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT

# é˜»æ­¢Clashä»£ç†ç«¯å£çš„å¤–éƒ¨è®¿é—®
iptables -A INPUT -p tcp --dport 7890 -s 127.0.0.1 -j ACCEPT
iptables -A INPUT -p tcp --dport 7891 -s 127.0.0.1 -j ACCEPT
iptables -A INPUT -p tcp --dport 9090 -s 127.0.0.1 -j ACCEPT
iptables -A INPUT -p tcp --dport 7890 -j REJECT
iptables -A INPUT -p tcp --dport 7891 -j REJECT
iptables -A INPUT -p tcp --dport 9090 -j REJECT

# è®°å½•è¢«æ‹’ç»çš„è¿æ¥
iptables -A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables denied: " --log-level 7

# æœ€ç»ˆæ‹’ç»æ‰€æœ‰å…¶ä»–è¿æ¥
iptables -A INPUT -j REJECT

# ä¿å­˜è§„åˆ™
iptables-save > /etc/iptables/rules.v4

echo "é˜²ç«å¢™è§„åˆ™é…ç½®å®Œæˆ"
```

#### UFWç®€åŒ–é…ç½®

```bash
#!/bin/bash
# UFWé˜²ç«å¢™é…ç½®

# é‡ç½®UFW
ufw --force reset

# é»˜è®¤ç­–ç•¥
ufw default deny incoming
ufw default allow outgoing

# SSHè®¿é—®
ufw allow ssh

# WebæœåŠ¡
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 8088/tcp

# é™åˆ¶è¿æ¥é€Ÿç‡
ufw limit ssh
ufw limit 8088/tcp

# æ‹’ç»ä»£ç†ç«¯å£çš„å¤–éƒ¨è®¿é—®
ufw deny 7890
ufw deny 7891
ufw deny 9090

# å¯ç”¨UFW
ufw --force enable

echo "UFWé˜²ç«å¢™é…ç½®å®Œæˆ"
```

### ç½‘ç»œéš”ç¦»

#### Dockerç½‘ç»œå®‰å…¨é…ç½®

```yaml
# å®‰å…¨çš„ç½‘ç»œé…ç½®
networks:
  # å†…éƒ¨ç½‘ç»œ - å®Œå…¨éš”ç¦»
  clash-internal:
    driver: bridge
    internal: true
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
    driver_opts:
      com.docker.network.bridge.enable_icc: "false"
      com.docker.network.bridge.enable_ip_masquerade: "false"
  
  # å¤–éƒ¨ç½‘ç»œ - å—é™è®¿é—®
  web-external:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.21.0.0/24
          gateway: 172.21.0.1
    driver_opts:
      com.docker.network.bridge.enable_icc: "false"
```

## è®¿é—®æ§åˆ¶å’Œè®¤è¯

### å¤šå±‚è®¤è¯é…ç½®

#### HTTPåŸºæœ¬è®¤è¯

åˆ›å»º `security/setup-auth.sh`:
```bash
#!/bin/bash
# è®¾ç½®HTTPè®¤è¯

USERNAME="${1:-admin}"
PASSWORD="${2:-}"

if [ -z "$PASSWORD" ]; then
    echo "è¯·è¾“å…¥å¯†ç :"
    read -s PASSWORD
fi

# ç”Ÿæˆå¯†ç å“ˆå¸Œ
htpasswd -c security/htpasswd "$USERNAME" <<< "$PASSWORD"

# è®¾ç½®æƒé™
chmod 640 security/htpasswd
chown root:docker security/htpasswd

echo "HTTPè®¤è¯é…ç½®å®Œæˆ"
echo "ç”¨æˆ·å: $USERNAME"
```

#### JWTä»¤ç‰Œè®¤è¯

åˆ›å»º `security/jwt-auth.lua` (Nginx Luaè„šæœ¬):
```lua
-- JWTè®¤è¯æ¨¡å—
local jwt = require "resty.jwt"

-- é…ç½®
local jwt_secret = os.getenv("JWT_SECRET") or "your-secret-key"
local jwt_token = ngx.var.http_authorization

-- éªŒè¯JWTä»¤ç‰Œ
if not jwt_token then
    ngx.status = 401
    ngx.say("Missing Authorization header")
    ngx.exit(401)
end

-- æå–Bearerä»¤ç‰Œ
local token = string.match(jwt_token, "Bearer%s+(.+)")
if not token then
    ngx.status = 401
    ngx.say("Invalid Authorization format")
    ngx.exit(401)
end

-- éªŒè¯JWT
local jwt_obj = jwt:verify(jwt_secret, token)
if not jwt_obj.valid then
    ngx.status = 401
    ngx.say("Invalid JWT token")
    ngx.exit(401)
end

-- æ£€æŸ¥è¿‡æœŸæ—¶é—´
local now = ngx.time()
if jwt_obj.payload.exp and jwt_obj.payload.exp < now then
    ngx.status = 401
    ngx.say("JWT token expired")
    ngx.exit(401)
end

-- è®¾ç½®ç”¨æˆ·ä¿¡æ¯
ngx.var.authenticated_user = jwt_obj.payload.sub or "unknown"
```

#### APIå¯†é’¥è®¤è¯

åˆ›å»º `security/api-key-auth.sh`:
```bash
#!/bin/bash
# APIå¯†é’¥ç®¡ç†

ACTION="$1"
KEY_NAME="$2"

API_KEYS_FILE="security/api-keys.json"

# ç”Ÿæˆæ–°çš„APIå¯†é’¥
generate_key() {
    local key_name="$1"
    local api_key=$(openssl rand -hex 32)
    local key_hash=$(echo -n "$api_key" | sha256sum | cut -d' ' -f1)
    
    # ä¿å­˜åˆ°å¯†é’¥æ–‡ä»¶
    if [ ! -f "$API_KEYS_FILE" ]; then
        echo '{}' > "$API_KEYS_FILE"
    fi
    
    jq --arg name "$key_name" --arg hash "$key_hash" --arg created "$(date -Iseconds)" \
       '.[$name] = {hash: $hash, created: $created, active: true}' \
       "$API_KEYS_FILE" > "$API_KEYS_FILE.tmp" && \
       mv "$API_KEYS_FILE.tmp" "$API_KEYS_FILE"
    
    echo "APIå¯†é’¥ç”ŸæˆæˆåŠŸ:"
    echo "åç§°: $key_name"
    echo "å¯†é’¥: $api_key"
    echo "è¯·å¦¥å–„ä¿å­˜æ­¤å¯†é’¥ï¼Œç³»ç»Ÿä¸ä¼šå†æ¬¡æ˜¾ç¤º"
}

# éªŒè¯APIå¯†é’¥
verify_key() {
    local api_key="$1"
    local key_hash=$(echo -n "$api_key" | sha256sum | cut -d' ' -f1)
    
    if [ ! -f "$API_KEYS_FILE" ]; then
        return 1
    fi
    
    # æ£€æŸ¥å¯†é’¥æ˜¯å¦å­˜åœ¨ä¸”æ´»è·ƒ
    if jq -e --arg hash "$key_hash" 'to_entries[] | select(.value.hash == $hash and .value.active == true)' "$API_KEYS_FILE" >/dev/null; then
        return 0
    else
        return 1
    fi
}

# æ’¤é”€APIå¯†é’¥
revoke_key() {
    local key_name="$1"
    
    jq --arg name "$key_name" '.[$name].active = false' \
       "$API_KEYS_FILE" > "$API_KEYS_FILE.tmp" && \
       mv "$API_KEYS_FILE.tmp" "$API_KEYS_FILE"
    
    echo "APIå¯†é’¥å·²æ’¤é”€: $key_name"
}

case "$ACTION" in
    "generate")
        generate_key "$KEY_NAME"
        ;;
    "verify")
        if verify_key "$KEY_NAME"; then
            echo "APIå¯†é’¥æœ‰æ•ˆ"
            exit 0
        else
            echo "APIå¯†é’¥æ— æ•ˆ"
            exit 1
        fi
        ;;
    "revoke")
        revoke_key "$KEY_NAME"
        ;;
    *)
        echo "ç”¨æ³•: $0 {generate|verify|revoke} <key_name_or_key>"
        exit 1
        ;;
esac
```

### IPç™½åå•

åˆ›å»º `security/ip-whitelist.conf`:
```nginx
# IPç™½åå•é…ç½®

# ç®¡ç†æ¥å£è®¿é—®æ§åˆ¶
location /api/admin {
    # å†…ç½‘IP
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    
    # ç‰¹å®šç®¡ç†IP
    allow 203.0.113.10;  # ç®¡ç†å‘˜åŠå…¬ç½‘ç»œ
    allow 198.51.100.20; # VPNå‡ºå£IP
    
    # æ‹’ç»å…¶ä»–æ‰€æœ‰IP
    deny all;
    
    proxy_pass http://clash_backend;
}

# é…ç½®æ–‡ä»¶è®¿é—®æ§åˆ¶
location /config.yaml {
    # å…è®¸æ›´å¹¿æ³›çš„è®¿é—®
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    allow 100.64.0.0/10;  # CGNAT
    
    # CDN IPæ®µ
    include /etc/nginx/conf.d/cdn-ips.conf;
    
    deny all;
    
    proxy_pass http://clash_backend;
}

# åŠ¨æ€IPç™½åå•æ›´æ–°
location /auth/whitelist {
    # ä»…å…è®¸æœ¬åœ°æ›´æ–°
    allow 127.0.0.1;
    deny all;
    
    content_by_lua_block {
        -- éªŒè¯APIå¯†é’¥
        local auth_header = ngx.var.http_x_api_key
        if not auth_header then
            ngx.status = 401
            ngx.say("Missing API key")
            return
        end
        
        -- è¿™é‡Œå®ç°åŠ¨æ€ç™½åå•æ›´æ–°é€»è¾‘
        -- å¯ä»¥ä¸å¤–éƒ¨è®¤è¯ç³»ç»Ÿé›†æˆ
    }
}
```

## æ•°æ®ä¿æŠ¤å’ŒåŠ å¯†

### æ•æ„Ÿæ•°æ®åŠ å¯†

#### ç¯å¢ƒå˜é‡åŠ å¯†

åˆ›å»º `security/encrypt-env.sh`:
```bash
#!/bin/bash
# ç¯å¢ƒå˜é‡åŠ å¯†å·¥å…·

set -euo pipefail

MASTER_KEY_FILE="security/master.key"
ENCRYPTED_ENV_FILE="security/.env.encrypted"

# ç”Ÿæˆä¸»å¯†é’¥
generate_master_key() {
    if [ ! -f "$MASTER_KEY_FILE" ]; then
        openssl rand -base64 32 > "$MASTER_KEY_FILE"
        chmod 600 "$MASTER_KEY_FILE"
        echo "ä¸»å¯†é’¥å·²ç”Ÿæˆ: $MASTER_KEY_FILE"
    else
        echo "ä¸»å¯†é’¥å·²å­˜åœ¨: $MASTER_KEY_FILE"
    fi
}

# åŠ å¯†ç¯å¢ƒæ–‡ä»¶
encrypt_env() {
    local env_file="${1:-.env}"
    
    if [ ! -f "$env_file" ]; then
        echo "é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨: $env_file"
        exit 1
    fi
    
    # è¯»å–ä¸»å¯†é’¥
    local master_key=$(cat "$MASTER_KEY_FILE")
    
    # åŠ å¯†æ–‡ä»¶
    openssl enc -aes-256-cbc -salt -pbkdf2 \
        -in "$env_file" \
        -out "$ENCRYPTED_ENV_FILE" \
        -pass pass:"$master_key"
    
    echo "ç¯å¢ƒæ–‡ä»¶å·²åŠ å¯†: $ENCRYPTED_ENV_FILE"
}

# è§£å¯†ç¯å¢ƒæ–‡ä»¶
decrypt_env() {
    local output_file="${1:-.env.decrypted}"
    
    if [ ! -f "$ENCRYPTED_ENV_FILE" ]; then
        echo "é”™è¯¯: åŠ å¯†æ–‡ä»¶ä¸å­˜åœ¨: $ENCRYPTED_ENV_FILE"
        exit 1
    fi
    
    # è¯»å–ä¸»å¯†é’¥
    local master_key=$(cat "$MASTER_KEY_FILE")
    
    # è§£å¯†æ–‡ä»¶
    openssl enc -aes-256-cbc -d -pbkdf2 \
        -in "$ENCRYPTED_ENV_FILE" \
        -out "$output_file" \
        -pass pass:"$master_key"
    
    echo "ç¯å¢ƒæ–‡ä»¶å·²è§£å¯†: $output_file"
}

# å®‰å…¨åˆ é™¤æ˜æ–‡æ–‡ä»¶
secure_delete() {
    local file="$1"
    
    if [ -f "$file" ]; then
        # å¤šæ¬¡è¦†å†™æ–‡ä»¶
        shred -vfz -n 3 "$file"
        echo "æ–‡ä»¶å·²å®‰å…¨åˆ é™¤: $file"
    fi
}

case "${1:-help}" in
    "generate-key")
        generate_master_key
        ;;
    "encrypt")
        generate_master_key
        encrypt_env "$2"
        ;;
    "decrypt")
        decrypt_env "$2"
        ;;
    "secure-delete")
        secure_delete "$2"
        ;;
    *)
        echo "ç”¨æ³•: $0 {generate-key|encrypt|decrypt|secure-delete} [file]"
        echo ""
        echo "å‘½ä»¤:"
        echo "  generate-key    - ç”Ÿæˆä¸»åŠ å¯†å¯†é’¥"
        echo "  encrypt [file]  - åŠ å¯†ç¯å¢ƒæ–‡ä»¶"
        echo "  decrypt [file]  - è§£å¯†ç¯å¢ƒæ–‡ä»¶"
        echo "  secure-delete   - å®‰å…¨åˆ é™¤æ–‡ä»¶"
        ;;
esac
```

#### å¯†é’¥ç®¡ç†

åˆ›å»º `security/key-management.sh`:
```bash
#!/bin/bash
# å¯†é’¥ç®¡ç†ç³»ç»Ÿ

set -euo pipefail

KEYSTORE_DIR="security/keystore"
BACKUP_DIR="security/key-backups"

mkdir -p "$KEYSTORE_DIR" "$BACKUP_DIR"

# ç”ŸæˆæœåŠ¡å¯†é’¥
generate_service_key() {
    local service_name="$1"
    local key_type="${2:-rsa}"  # rsa, ecdsa, ed25519
    local key_size="${3:-4096}"
    
    local key_file="$KEYSTORE_DIR/${service_name}.key"
    local pub_file="$KEYSTORE_DIR/${service_name}.pub"
    
    case "$key_type" in
        "rsa")
            openssl genrsa -out "$key_file" "$key_size"
            openssl rsa -in "$key_file" -pubout -out "$pub_file"
            ;;
        "ecdsa")
            openssl ecparam -name secp384r1 -genkey -noout -out "$key_file"
            openssl ec -in "$key_file" -pubout -out "$pub_file"
            ;;
        "ed25519")
            openssl genpkey -algorithm Ed25519 -out "$key_file"
            openssl pkey -in "$key_file" -pubout -out "$pub_file"
            ;;
        *)
            echo "ä¸æ”¯æŒçš„å¯†é’¥ç±»å‹: $key_type"
            exit 1
            ;;
    esac
    
    # è®¾ç½®æƒé™
    chmod 600 "$key_file"
    chmod 644 "$pub_file"
    
    echo "æœåŠ¡å¯†é’¥å·²ç”Ÿæˆ:"
    echo "ç§é’¥: $key_file"
    echo "å…¬é’¥: $pub_file"
}

# è½®æ¢å¯†é’¥
rotate_key() {
    local service_name="$1"
    local key_file="$KEYSTORE_DIR/${service_name}.key"
    local pub_file="$KEYSTORE_DIR/${service_name}.pub"
    
    if [ -f "$key_file" ]; then
        # å¤‡ä»½æ—§å¯†é’¥
        local timestamp=$(date +%Y%m%d_%H%M%S)
        cp "$key_file" "$BACKUP_DIR/${service_name}_${timestamp}.key"
        cp "$pub_file" "$BACKUP_DIR/${service_name}_${timestamp}.pub"
        
        echo "æ—§å¯†é’¥å·²å¤‡ä»½åˆ°: $BACKUP_DIR"
    fi
    
    # ç”Ÿæˆæ–°å¯†é’¥
    generate_service_key "$service_name"
    
    echo "å¯†é’¥è½®æ¢å®Œæˆ: $service_name"
}

# éªŒè¯å¯†é’¥å¯¹
verify_keypair() {
    local service_name="$1"
    local key_file="$KEYSTORE_DIR/${service_name}.key"
    local pub_file="$KEYSTORE_DIR/${service_name}.pub"
    
    if [ ! -f "$key_file" ] || [ ! -f "$pub_file" ]; then
        echo "å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨"
        return 1
    fi
    
    # ç”Ÿæˆæµ‹è¯•æ•°æ®
    local test_data="test message for key verification"
    local signature_file="/tmp/test_signature"
    local verified_file="/tmp/test_verified"
    
    # ç­¾åå’ŒéªŒè¯
    echo "$test_data" | openssl dgst -sha256 -sign "$key_file" > "$signature_file"
    
    if echo "$test_data" | openssl dgst -sha256 -verify "$pub_file" -signature "$signature_file"; then
        echo "å¯†é’¥å¯¹éªŒè¯æˆåŠŸ: $service_name"
        rm -f "$signature_file" "$verified_file"
        return 0
    else
        echo "å¯†é’¥å¯¹éªŒè¯å¤±è´¥: $service_name"
        rm -f "$signature_file" "$verified_file"
        return 1
    fi
}

# å¯†é’¥å¤‡ä»½
backup_keys() {
    local backup_file="$BACKUP_DIR/keystore_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    
    tar -czf "$backup_file" -C "$KEYSTORE_DIR" .
    
    # åŠ å¯†å¤‡ä»½
    openssl enc -aes-256-cbc -salt -pbkdf2 \
        -in "$backup_file" \
        -out "${backup_file}.encrypted" \
        -pass pass:"$(cat security/master.key)"
    
    # åˆ é™¤æ˜æ–‡å¤‡ä»½
    rm "$backup_file"
    
    echo "å¯†é’¥å¤‡ä»½å®Œæˆ: ${backup_file}.encrypted"
}

case "${1:-help}" in
    "generate")
        generate_service_key "$2" "${3:-rsa}" "${4:-4096}"
        ;;
    "rotate")
        rotate_key "$2"
        ;;
    "verify")
        verify_keypair "$2"
        ;;
    "backup")
        backup_keys
        ;;
    *)
        echo "ç”¨æ³•: $0 {generate|rotate|verify|backup} [service_name] [key_type] [key_size]"
        echo ""
        echo "å‘½ä»¤:"
        echo "  generate <name> [type] [size] - ç”ŸæˆæœåŠ¡å¯†é’¥"
        echo "  rotate <name>                 - è½®æ¢å¯†é’¥"
        echo "  verify <name>                 - éªŒè¯å¯†é’¥å¯¹"
        echo "  backup                        - å¤‡ä»½æ‰€æœ‰å¯†é’¥"
        ;;
esac
```

## å®‰å…¨ç›‘æ§å’Œå®¡è®¡

### å®‰å…¨äº‹ä»¶ç›‘æ§

åˆ›å»º `security/security-monitor.sh`:
```bash
#!/bin/bash
# å®‰å…¨äº‹ä»¶ç›‘æ§

set -euo pipefail

LOG_DIR="/var/log/security"
ALERT_LOG="$LOG_DIR/security-alerts.log"
THREAT_DB="security/threat-indicators.json"

mkdir -p "$LOG_DIR"

# ç›‘æ§å¼‚å¸¸ç™»å½•
monitor_auth_events() {
    echo "ç›‘æ§è®¤è¯äº‹ä»¶..."
    
    # ç›‘æ§SSHç™»å½•å¤±è´¥
    journalctl -u ssh --since "1 hour ago" | grep "Failed password" | while read line; do
        local ip=$(echo "$line" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+')
        local timestamp=$(echo "$line" | cut -d' ' -f1-3)
        
        echo "[$timestamp] SSHç™»å½•å¤±è´¥: $ip" >> "$ALERT_LOG"
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºå·²çŸ¥å¨èƒIP
        if check_threat_ip "$ip"; then
            send_alert "HIGH" "å·²çŸ¥å¨èƒIPå°è¯•SSHç™»å½•: $ip"
        fi
    done
    
    # ç›‘æ§Webè®¤è¯å¤±è´¥
    nginx_log="/var/log/nginx/access.log"
    if [ -f "$nginx_log" ]; then
        tail -n 1000 "$nginx_log" | grep " 401 " | while read line; do
            local ip=$(echo "$line" | cut -d' ' -f1)
            local timestamp=$(echo "$line" | cut -d'[' -f2 | cut -d']' -f1)
            
            echo "[$timestamp] Webè®¤è¯å¤±è´¥: $ip" >> "$ALERT_LOG"
        done
    fi
}

# ç›‘æ§ç½‘ç»œå¼‚å¸¸
monitor_network_events() {
    echo "ç›‘æ§ç½‘ç»œäº‹ä»¶..."
    
    # ç›‘æ§ç«¯å£æ‰«æ
    netstat -an | grep ":8088 " | grep SYN_RECV | wc -l | while read count; do
        if [ "$count" -gt 50 ]; then
            send_alert "MEDIUM" "æ£€æµ‹åˆ°å¯èƒ½çš„ç«¯å£æ‰«æï¼ŒSYN_RECVè¿æ¥æ•°: $count"
        fi
    done
    
    # ç›‘æ§å¼‚å¸¸å¤§é‡è¿æ¥
    netstat -an | grep ":8088 " | grep ESTABLISHED | awk '{print $5}' | cut -d':' -f1 | sort | uniq -c | sort -nr | head -5 | while read count ip; do
        if [ "$count" -gt 20 ]; then
            echo "[$(date)] å¼‚å¸¸è¿æ¥æ•°é‡: $ip ($count connections)" >> "$ALERT_LOG"
            send_alert "MEDIUM" "IP $ip å»ºç«‹äº† $count ä¸ªè¿æ¥ï¼Œå¯èƒ½å­˜åœ¨å¼‚å¸¸"
        fi
    done
}

# ç›‘æ§æ–‡ä»¶å®Œæ•´æ€§
monitor_file_integrity() {
    echo "ç›‘æ§æ–‡ä»¶å®Œæ•´æ€§..."
    
    local checksum_file="security/file-checksums.txt"
    local current_checksums="/tmp/current-checksums.txt"
    
    # è®¡ç®—å…³é”®æ–‡ä»¶çš„æ ¡éªŒå’Œ
    find config/ security/ -type f -name "*.yaml" -o -name "*.conf" -o -name "*.sh" | xargs sha256sum > "$current_checksums"
    
    if [ -f "$checksum_file" ]; then
        # æ¯”è¾ƒæ ¡éªŒå’Œ
        if ! diff -q "$checksum_file" "$current_checksums" >/dev/null; then
            echo "[$(date)] æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥" >> "$ALERT_LOG"
            send_alert "HIGH" "æ£€æµ‹åˆ°å…³é”®æ–‡ä»¶è¢«ä¿®æ”¹"
            
            # æ˜¾ç¤ºå·®å¼‚
            diff "$checksum_file" "$current_checksums" >> "$ALERT_LOG"
        fi
    fi
    
    # æ›´æ–°æ ¡éªŒå’Œ
    cp "$current_checksums" "$checksum_file"
    rm "$current_checksums"
}

# ç›‘æ§å®¹å™¨è¿è¡Œæ—¶
monitor_container_runtime() {
    echo "ç›‘æ§å®¹å™¨è¿è¡Œæ—¶..."
    
    # æ£€æŸ¥å®¹å™¨æ˜¯å¦ä»¥rootè¿è¡Œ
    docker ps --format "table {{.Names}}\t{{.Image}}" | tail -n +2 | while read name image; do
        local user=$(docker exec "$name" whoami 2>/dev/null || echo "unknown")
        if [ "$user" = "root" ]; then
            send_alert "HIGH" "å®¹å™¨ $name ä»¥rootç”¨æˆ·è¿è¡Œ"
        fi
    done
    
    # æ£€æŸ¥å®¹å™¨èµ„æºä½¿ç”¨
    docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemPerc}}" | tail -n +2 | while read name cpu mem; do
        cpu_num=$(echo "$cpu" | sed 's/%//')
        mem_num=$(echo "$mem" | sed 's/%//')
        
        if [ "${cpu_num%.*}" -gt 80 ]; then
            send_alert "MEDIUM" "å®¹å™¨ $name CPUä½¿ç”¨ç‡è¿‡é«˜: $cpu"
        fi
        
        if [ "${mem_num%.*}" -gt 80 ]; then
            send_alert "MEDIUM" "å®¹å™¨ $name å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: $mem"
        fi
    done
}

# æ£€æŸ¥å¨èƒIP
check_threat_ip() {
    local ip="$1"
    
    if [ -f "$THREAT_DB" ]; then
        if jq -e --arg ip "$ip" '.threat_ips[] | select(. == $ip)' "$THREAT_DB" >/dev/null; then
            return 0
        fi
    fi
    
    return 1
}

# å‘é€å‘Šè­¦
send_alert() {
    local level="$1"
    local message="$2"
    local timestamp=$(date -Iseconds)
    
    # è®°å½•åˆ°æ—¥å¿—
    echo "[$timestamp] [$level] $message" >> "$ALERT_LOG"
    
    # å‘é€é‚®ä»¶å‘Šè­¦ (å¦‚æœé…ç½®äº†)
    if [ -n "${ALERT_EMAIL:-}" ]; then
        echo "$message" | mail -s "Security Alert [$level]" "$ALERT_EMAIL"
    fi
    
    # å‘é€åˆ°Slack (å¦‚æœé…ç½®äº†)
    if [ -n "${SLACK_WEBHOOK:-}" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ Security Alert [$level]: $message\"}" \
            "$SLACK_WEBHOOK"
    fi
    
    # è®°å½•åˆ°syslog
    logger -p security.warn "Clash Docker Security Alert [$level]: $message"
}

# ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
generate_security_report() {
    local report_file="$LOG_DIR/security-report-$(date +%Y%m%d).txt"
    
    {
        echo "=== å®‰å…¨ç›‘æ§æ—¥æŠ¥ ==="
        echo "æ—¥æœŸ: $(date)"
        echo ""
        
        echo "=== å‘Šè­¦æ‘˜è¦ ==="
        if [ -f "$ALERT_LOG" ]; then
            tail -n 100 "$ALERT_LOG" | grep "$(date +%Y-%m-%d)" | \
            awk '{print $3}' | sort | uniq -c | sort -nr
        else
            echo "æ— å‘Šè­¦è®°å½•"
        fi
        echo ""
        
        echo "=== è®¤è¯å¤±è´¥ç»Ÿè®¡ ==="
        grep "è®¤è¯å¤±è´¥" "$ALERT_LOG" 2>/dev/null | grep "$(date +%Y-%m-%d)" | wc -l || echo "0"
        echo ""
        
        echo "=== ç½‘ç»œå¼‚å¸¸ç»Ÿè®¡ ==="
        grep "å¼‚å¸¸è¿æ¥" "$ALERT_LOG" 2>/dev/null | grep "$(date +%Y-%m-%d)" | wc -l || echo "0"
        echo ""
        
        echo "=== å®¹å™¨çŠ¶æ€ ==="
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        echo ""
        
        echo "=== ç³»ç»Ÿèµ„æºä½¿ç”¨ ==="
        df -h | grep -E "(/$|/app)"
        free -h
        uptime
        
    } > "$report_file"
    
    echo "å®‰å…¨æŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
}

# ä¸»ç›‘æ§å¾ªç¯
main() {
    echo "å¯åŠ¨å®‰å…¨ç›‘æ§ - $(date)"
    
    while true; do
        monitor_auth_events
        monitor_network_events
        monitor_file_integrity
        monitor_container_runtime
        
        # æ¯å°æ—¶ç”Ÿæˆä¸€æ¬¡æŠ¥å‘Š
        if [ "$(date +%M)" = "00" ]; then
            generate_security_report
        fi
        
        # ç­‰å¾…60ç§’
        sleep 60
    done
}

# å¦‚æœç›´æ¥è¿è¡Œè„šæœ¬
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    main "$@"
fi
```

### å®¡è®¡æ—¥å¿—é…ç½®

åˆ›å»º `security/audit-config.sh`:
```bash
#!/bin/bash
# å®¡è®¡æ—¥å¿—é…ç½®

set -euo pipefail

# é…ç½®auditdè§„åˆ™
configure_auditd() {
    echo "é…ç½®auditdå®¡è®¡..."
    
    # å®‰è£…auditd
    if ! command -v auditctl >/dev/null; then
        apt update && apt install -y auditd
    fi
    
    # é…ç½®å®¡è®¡è§„åˆ™
    cat > /etc/audit/rules.d/clash-docker.rules << EOF
# Clash Docker å®¡è®¡è§„åˆ™

# ç›‘æ§å…³é”®ç›®å½•
-w /app/config -p wa -k clash-config-change
-w /app/security -p wa -k security-change
-w /etc/docker -p wa -k docker-config-change

# ç›‘æ§å…³é”®æ–‡ä»¶
-w /etc/passwd -p wa -k user-change
-w /etc/shadow -p wa -k password-change
-w /etc/group -p wa -k group-change
-w /etc/sudoers -p wa -k sudo-change

# ç›‘æ§ç½‘ç»œé…ç½®
-w /etc/hosts -p wa -k network-config
-w /etc/iptables -p wa -k firewall-change

# ç›‘æ§è¿›ç¨‹æ‰§è¡Œ
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/docker -k docker-exec
-a always,exit -F arch=b64 -S execve -F path=/usr/local/bin/docker-compose -k compose-exec

# ç›‘æ§æ–‡ä»¶æƒé™å˜æ›´
-a always,exit -F arch=b64 -S chmod -S fchmod -S chown -S fchown -k file-perm-change

# ç›‘æ§ç½‘ç»œè¿æ¥
-a always,exit -F arch=b64 -S socket -S connect -S accept -k network-connect
EOF

    # é‡å¯auditd
    systemctl restart auditd
    systemctl enable auditd
    
    echo "auditdé…ç½®å®Œæˆ"
}

# é…ç½®rsyslogå®¡è®¡æ—¥å¿—
configure_rsyslog() {
    echo "é…ç½®rsyslogå®¡è®¡æ—¥å¿—..."
    
    cat > /etc/rsyslog.d/50-clash-docker.conf << EOF
# Clash Docker æ—¥å¿—é…ç½®

# å®‰å…¨ç›¸å…³æ—¥å¿—
auth,authpriv.*                 /var/log/auth.log
security.*                      /var/log/security.log

# Dockeræ—¥å¿—
daemon.info                     /var/log/docker.log

# è‡ªå®šä¹‰åº”ç”¨æ—¥å¿—
local0.*                        /var/log/clash-docker.log

# è¿œç¨‹æ—¥å¿— (å¯é€‰)
# *.* @@logserver:514

# æ—¥å¿—è½®è½¬
\$ModLoad imfile
\$InputFileName /app/logs/clash.log
\$InputFileTag clash:
\$InputFileStateFile clash-log
\$InputFileSeverity info
\$InputFileFacility local0
\$InputRunFileMonitor
EOF

    # é‡å¯rsyslog
    systemctl restart rsyslog
    
    echo "rsyslogé…ç½®å®Œæˆ"
}

# é…ç½®logrotate
configure_logrotate() {
    echo "é…ç½®æ—¥å¿—è½®è½¬..."
    
    cat > /etc/logrotate.d/clash-docker << EOF
/var/log/clash-docker.log
/var/log/security.log
/app/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 root root
    postrotate
        /bin/kill -HUP \`cat /var/run/rsyslogd.pid 2> /dev/null\` 2> /dev/null || true
    endscript
}

/app/security/scan-results/*.log {
    weekly
    missingok
    rotate 12
    compress
    delaycompress
    notifempty
    create 644 root root
}
EOF

    echo "logrotateé…ç½®å®Œæˆ"
}

# ä¸»é…ç½®æµç¨‹
main() {
    echo "å¼€å§‹é…ç½®å®¡è®¡æ—¥å¿—..."
    
    configure_auditd
    configure_rsyslog
    configure_logrotate
    
    echo "å®¡è®¡æ—¥å¿—é…ç½®å®Œæˆ"
    echo "å®¡è®¡æ—¥å¿—ä½ç½®:"
    echo "  - ç³»ç»Ÿå®¡è®¡: /var/log/audit/audit.log"
    echo "  - å®‰å…¨æ—¥å¿—: /var/log/security.log"
    echo "  - åº”ç”¨æ—¥å¿—: /var/log/clash-docker.log"
    echo "  - è®¤è¯æ—¥å¿—: /var/log/auth.log"
}

main "$@"
```

## å®‰å…¨æ‰«æå’Œæ£€æµ‹

### æ¼æ´æ‰«æ

åˆ›å»º `security/vulnerability-scan.sh`:
```bash
#!/bin/bash
# æ¼æ´æ‰«æè„šæœ¬

set -euo pipefail

SCAN_DIR="security/scan-results"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

mkdir -p "$SCAN_DIR"

# ç½‘ç»œæ¼æ´æ‰«æ
network_vulnerability_scan() {
    echo "æ‰§è¡Œç½‘ç»œæ¼æ´æ‰«æ..."
    
    local target="${1:-localhost}"
    local scan_file="$SCAN_DIR/network_vuln_$TIMESTAMP.txt"
    
    # ä½¿ç”¨nmapè¿›è¡ŒåŸºç¡€æ‰«æ
    nmap -sV -sC --script vuln "$target" > "$scan_file" 2>&1
    
    echo "ç½‘ç»œæ‰«æå®Œæˆ: $scan_file"
}

# åº”ç”¨æ¼æ´æ‰«æ
application_vulnerability_scan() {
    echo "æ‰§è¡Œåº”ç”¨æ¼æ´æ‰«æ..."
    
    local base_url="${1:-http://localhost:8088}"
    local scan_file="$SCAN_DIR/app_vuln_$TIMESTAMP.txt"
    
    {
        echo "=== åº”ç”¨æ¼æ´æ‰«ææŠ¥å‘Š ==="
        echo "ç›®æ ‡: $base_url"
        echo "æ—¶é—´: $(date)"
        echo ""
        
        # HTTPå¤´å®‰å…¨æ£€æŸ¥
        echo "=== HTTPå®‰å…¨å¤´æ£€æŸ¥ ==="
        curl -I "$base_url" 2>/dev/null | grep -E "(X-Frame-Options|X-Content-Type-Options|Strict-Transport-Security|Content-Security-Policy)" || echo "ç¼ºå°‘å®‰å…¨å¤´"
        echo ""
        
        # SSL/TLSé…ç½®æ£€æŸ¥
        if [[ "$base_url" == https* ]]; then
            echo "=== SSL/TLSé…ç½®æ£€æŸ¥ ==="
            local domain=$(echo "$base_url" | sed 's|https://||' | cut -d'/' -f1)
            echo | openssl s_client -connect "$domain:443" -servername "$domain" 2>/dev/null | openssl x509 -noout -text | grep -E "(Signature Algorithm|Public Key|Not After)"
            echo ""
        fi
        
        # è·¯å¾„éå†æµ‹è¯•
        echo "=== è·¯å¾„éå†æµ‹è¯• ==="
        for path in "../etc/passwd" "..%2F..%2Fetc%2Fpasswd" "....//....//etc/passwd"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$base_url/$path")
            echo "è·¯å¾„: $path -> HTTP $response"
        done
        echo ""
        
        # SQLæ³¨å…¥æµ‹è¯• (åŸºç¡€)
        echo "=== SQLæ³¨å…¥æµ‹è¯• ==="
        for payload in "'" "1' OR '1'='1" "1; DROP TABLE users--"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$base_url/api/test?id=$payload")
            echo "Payload: $payload -> HTTP $response"
        done
        echo ""
        
        # XSSæµ‹è¯• (åŸºç¡€)
        echo "=== XSSæµ‹è¯• ==="
        for payload in "<script>alert('xss')</script>" "\"><script>alert('xss')</script>"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$base_url/?search=$payload")
            echo "Payload: $payload -> HTTP $response"
        done
        
    } > "$scan_file"
    
    echo "åº”ç”¨æ‰«æå®Œæˆ: $scan_file"
}

# é…ç½®å®‰å…¨æ£€æŸ¥
configuration_security_scan() {
    echo "æ‰§è¡Œé…ç½®å®‰å…¨æ£€æŸ¥..."
    
    local scan_file="$SCAN_DIR/config_security_$TIMESTAMP.txt"
    
    {
        echo "=== é…ç½®å®‰å…¨æ£€æŸ¥æŠ¥å‘Š ==="
        echo "æ—¶é—´: $(date)"
        echo ""
        
        echo "=== Dockeré…ç½®æ£€æŸ¥ ==="
        
        # æ£€æŸ¥å®¹å™¨æ˜¯å¦ä»¥rootè¿è¡Œ
        echo "æ£€æŸ¥å®¹å™¨ç”¨æˆ·:"
        docker ps --format "table {{.Names}}\t{{.Image}}" | tail -n +2 | while read name image; do
            user=$(docker exec "$name" whoami 2>/dev/null || echo "unknown")
            echo "  $name: $user"
        done
        echo ""
        
        # æ£€æŸ¥ç«¯å£ç»‘å®š
        echo "æ£€æŸ¥ç«¯å£ç»‘å®š:"
        docker ps --format "table {{.Names}}\t{{.Ports}}" | tail -n +2
        echo ""
        
        # æ£€æŸ¥æŒ‚è½½çš„ç›®å½•æƒé™
        echo "æ£€æŸ¥æŒ‚è½½ç›®å½•æƒé™:"
        ls -la config/ data/ logs/ 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
        echo ""
        
        echo "=== æ–‡ä»¶æƒé™æ£€æŸ¥ ==="
        
        # æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶æƒé™
        for file in .env security/htpasswd security/*.key; do
            if [ -f "$file" ]; then
                echo "  $(ls -la "$file")"
            fi
        done
        echo ""
        
        echo "=== ç½‘ç»œé…ç½®æ£€æŸ¥ ==="
        
        # æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
        if command -v ufw >/dev/null; then
            echo "UFWçŠ¶æ€:"
            ufw status
        elif command -v iptables >/dev/null; then
            echo "iptablesè§„åˆ™æ•°é‡:"
            iptables -L | wc -l
        fi
        echo ""
        
        # æ£€æŸ¥å¼€æ”¾ç«¯å£
        echo "å¼€æ”¾ç«¯å£:"
        netstat -tlnp | grep LISTEN
        
    } > "$scan_file"
    
    echo "é…ç½®æ£€æŸ¥å®Œæˆ: $scan_file"
}

# æ¶æ„è½¯ä»¶æ£€æŸ¥
malware_scan() {
    echo "æ‰§è¡Œæ¶æ„è½¯ä»¶æ£€æŸ¥..."
    
    local scan_file="$SCAN_DIR/malware_scan_$TIMESTAMP.txt"
    
    # ä½¿ç”¨ClamAVæ‰«æ
    if command -v clamscan >/dev/null; then
        echo "ä½¿ç”¨ClamAVæ‰«æ..."
        clamscan -r --log="$scan_file" /app/ /etc/ /var/log/ 2>&1
    else
        echo "ClamAVæœªå®‰è£…ï¼Œæ‰§è¡ŒåŸºç¡€æ–‡ä»¶æ£€æŸ¥..."
        
        {
            echo "=== åŸºç¡€æ¶æ„è½¯ä»¶æ£€æŸ¥ ==="
            echo "æ—¶é—´: $(date)"
            echo ""
            
            # æ£€æŸ¥å¯ç–‘æ–‡ä»¶
            echo "æ£€æŸ¥å¯ç–‘æ–‡ä»¶æ‰©å±•å:"
            find /app/ -type f \( -name "*.exe" -o -name "*.bat" -o -name "*.cmd" -o -name "*.scr" \) 2>/dev/null || echo "æœªå‘ç°å¯ç–‘æ–‡ä»¶"
            echo ""
            
            # æ£€æŸ¥éšè—æ–‡ä»¶
            echo "æ£€æŸ¥éšè—æ–‡ä»¶:"
            find /app/ -name ".*" -type f ! -name ".env*" ! -name ".git*" 2>/dev/null || echo "æœªå‘ç°å¼‚å¸¸éšè—æ–‡ä»¶"
            echo ""
            
            # æ£€æŸ¥å¼‚å¸¸ç½‘ç»œè¿æ¥
            echo "æ£€æŸ¥å¼‚å¸¸ç½‘ç»œè¿æ¥:"
            netstat -an | grep ESTABLISHED | grep -v -E "(127.0.0.1|localhost|:22|:80|:443|:8088)" || echo "æœªå‘ç°å¼‚å¸¸è¿æ¥"
            
        } > "$scan_file"
    fi
    
    echo "æ¶æ„è½¯ä»¶æ£€æŸ¥å®Œæˆ: $scan_file"
}

# ç”Ÿæˆç»¼åˆå®‰å…¨æŠ¥å‘Š
generate_security_report() {
    echo "ç”Ÿæˆç»¼åˆå®‰å…¨æŠ¥å‘Š..."
    
    local report_file="$SCAN_DIR/security_comprehensive_report_$TIMESTAMP.html"
    
    cat > "$report_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>Clash Docker å®‰å…¨æ‰«ææŠ¥å‘Š</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background-color: #f0f0f0; padding: 10px; border-radius: 5px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .high-risk { background-color: #ffebee; border-color: #f44336; }
        .medium-risk { background-color: #fff3e0; border-color: #ff9800; }
        .low-risk { background-color: #e8f5e8; border-color: #4caf50; }
        .info { background-color: #e3f2fd; border-color: #2196f3; }
        pre { background-color: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .risk-high { color: #d32f2f; font-weight: bold; }
        .risk-medium { color: #f57c00; font-weight: bold; }
        .risk-low { color: #388e3c; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” Clash Docker å®‰å…¨æ‰«ææŠ¥å‘Š</h1>
        <p><strong>æ‰«ææ—¶é—´:</strong> $(date)</p>
        <p><strong>æ‰«æèŒƒå›´:</strong> ç½‘ç»œã€åº”ç”¨ã€é…ç½®ã€æ¶æ„è½¯ä»¶</p>
    </div>

    <div class="section info">
        <h2>ğŸ“Š æ‰«ææ‘˜è¦</h2>
        <ul>
            <li>ç½‘ç»œæ¼æ´æ‰«æ: <a href="network_vuln_$TIMESTAMP.txt">æŸ¥çœ‹æŠ¥å‘Š</a></li>
            <li>åº”ç”¨æ¼æ´æ‰«æ: <a href="app_vuln_$TIMESTAMP.txt">æŸ¥çœ‹æŠ¥å‘Š</a></li>
            <li>é…ç½®å®‰å…¨æ£€æŸ¥: <a href="config_security_$TIMESTAMP.txt">æŸ¥çœ‹æŠ¥å‘Š</a></li>
            <li>æ¶æ„è½¯ä»¶æ£€æŸ¥: <a href="malware_scan_$TIMESTAMP.txt">æŸ¥çœ‹æŠ¥å‘Š</a></li>
        </ul>
    </div>

    <div class="section high-risk">
        <h2>ğŸš¨ é«˜é£é™©å‘ç°</h2>
        <ul>
EOF

    # æ£€æŸ¥é«˜é£é™©é¡¹ç›®
    if grep -q "CVE-" "$SCAN_DIR"/network_vuln_$TIMESTAMP.txt 2>/dev/null; then
        echo "            <li class=\"risk-high\">å‘ç°å·²çŸ¥CVEæ¼æ´</li>" >> "$report_file"
    fi
    
    if grep -q "root" "$SCAN_DIR"/config_security_$TIMESTAMP.txt 2>/dev/null; then
        echo "            <li class=\"risk-high\">å‘ç°ä»¥rootç”¨æˆ·è¿è¡Œçš„å®¹å™¨</li>" >> "$report_file"
    fi
    
    cat >> "$report_file" << EOF
        </ul>
    </div>

    <div class="section medium-risk">
        <h2>âš ï¸ ä¸­é£é™©å‘ç°</h2>
        <ul>
EOF

    # æ£€æŸ¥ä¸­é£é™©é¡¹ç›®
    if ! grep -q "X-Frame-Options" "$SCAN_DIR"/app_vuln_$TIMESTAMP.txt 2>/dev/null; then
        echo "            <li class=\"risk-medium\">ç¼ºå°‘å®‰å…¨å“åº”å¤´</li>" >> "$report_file"
    fi
    
    cat >> "$report_file" << EOF
        </ul>
    </div>

    <div class="section low-risk">
        <h2>â„¹ï¸ å»ºè®®æ”¹è¿›</h2>
        <ul>
            <li class="risk-low">å®šæœŸæ›´æ–°ä¾èµ–åŒ…</li>
            <li class="risk-low">åŠ å¼ºæ—¥å¿—ç›‘æ§</li>
            <li class="risk-low">å®æ–½å®šæœŸå®‰å…¨æ‰«æ</li>
        </ul>
    </div>

    <div class="section info">
        <h2>ğŸ“‹ åç»­è¡ŒåŠ¨</h2>
        <ol>
            <li>ç«‹å³ä¿®å¤æ‰€æœ‰é«˜é£é™©é—®é¢˜</li>
            <li>åˆ¶å®šä¸­é£é™©é—®é¢˜çš„ä¿®å¤è®¡åˆ’</li>
            <li>å»ºç«‹å®šæœŸå®‰å…¨æ‰«ææœºåˆ¶</li>
            <li>æ›´æ–°å®‰å…¨ç­–ç•¥å’Œç¨‹åº</li>
        </ol>
    </div>

    <div class="header">
        <p><strong>æŠ¥å‘Šç”Ÿæˆæ—¶é—´:</strong> $(date)</p>
        <p><strong>ä¸‹æ¬¡æ‰«æå»ºè®®:</strong> $(date -d '+1 week')</p>
    </div>
</body>
</html>
EOF

    echo "ç»¼åˆå®‰å…¨æŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
}

# ä¸»æ‰«ææµç¨‹
main() {
    local target="${1:-localhost}"
    local base_url="${2:-http://localhost:8088}"
    
    echo "å¼€å§‹å®‰å…¨æ‰«æ - $TIMESTAMP"
    echo "ç›®æ ‡: $target"
    echo "åº”ç”¨URL: $base_url"
    echo ""
    
    network_vulnerability_scan "$target"
    application_vulnerability_scan "$base_url"
    configuration_security_scan
    malware_scan
    generate_security_report
    
    echo ""
    echo "å®‰å…¨æ‰«æå®Œæˆ!"
    echo "æ‰«æç»“æœä¿å­˜åœ¨: $SCAN_DIR"
    echo ""
    echo "å»ºè®®ç«‹å³æŸ¥çœ‹å¹¶å¤„ç†é«˜é£é™©é—®é¢˜ã€‚"
}

main "$@"
```

## äº‹ä»¶å“åº”å’Œæ¢å¤

### å®‰å…¨äº‹ä»¶å“åº”æµç¨‹

åˆ›å»º `security/incident-response.sh`:
```bash
#!/bin/bash
# å®‰å…¨äº‹ä»¶å“åº”è„šæœ¬

set -euo pipefail

INCIDENT_DIR="security/incidents"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
INCIDENT_ID="INC-$TIMESTAMP"

mkdir -p "$INCIDENT_DIR"

# äº‹ä»¶åˆ†ç±»
declare -A INCIDENT_TYPES=(
    ["1"]="æ•°æ®æ³„éœ²"
    ["2"]="æœªæˆæƒè®¿é—®"
    ["3"]="æ¶æ„è½¯ä»¶æ„ŸæŸ“"
    ["4"]="DDoSæ”»å‡»"
    ["5"]="ç³»ç»Ÿå…¥ä¾µ"
    ["6"]="é…ç½®é”™è¯¯"
    ["7"]="å…¶ä»–å®‰å…¨äº‹ä»¶"
)

# ä¸¥é‡æ€§çº§åˆ«
declare -A SEVERITY_LEVELS=(
    ["1"]="ä½é£é™©"
    ["2"]="ä¸­é£é™©"
    ["3"]="é«˜é£é™©"
    ["4"]="ä¸¥é‡"
)

# åˆ›å»ºäº‹ä»¶æŠ¥å‘Š
create_incident_report() {
    local incident_type="$1"
    local severity="$2"
    local description="$3"
    
    local report_file="$INCIDENT_DIR/$INCIDENT_ID.md"
    
    cat > "$report_file" << EOF
# å®‰å…¨äº‹ä»¶æŠ¥å‘Š

**äº‹ä»¶ID**: $INCIDENT_ID
**æŠ¥å‘Šæ—¶é—´**: $(date -Iseconds)
**äº‹ä»¶ç±»å‹**: ${INCIDENT_TYPES[$incident_type]}
**ä¸¥é‡æ€§çº§åˆ«**: ${SEVERITY_LEVELS[$severity]}

## äº‹ä»¶æè¿°

$description

## äº‹ä»¶æ—¶é—´çº¿

- **$(date -Iseconds)**: äº‹ä»¶è¢«å‘ç°å¹¶æŠ¥å‘Š

## åˆæ­¥å½±å“è¯„ä¼°

- **å½±å“ç³»ç»Ÿ**: å¾…è¯„ä¼°
- **æ•°æ®æ³„éœ²**: å¾…è¯„ä¼°
- **æœåŠ¡ä¸­æ–­**: å¾…è¯„ä¼°
- **ç”¨æˆ·å½±å“**: å¾…è¯„ä¼°

## å“åº”çŠ¶æ€

- **çŠ¶æ€**: æ­£åœ¨å¤„ç†
- **å“åº”å›¢é˜Ÿ**: å®‰å…¨è¿ç»´å›¢é˜Ÿ
- **é¢„è®¡è§£å†³æ—¶é—´**: å¾…è¯„ä¼°

## å“åº”æ­¥éª¤

1. [ ] åˆæ­¥è°ƒæŸ¥
2. [ ] å½±å“è¯„ä¼°
3. [ ] éåˆ¶æªæ–½
4. [ ] æ ¹å› åˆ†æ
5. [ ] ç³»ç»Ÿæ¢å¤
6. [ ] äº‹ååˆ†æ

## è¯æ®æ”¶é›†

### ç³»ç»Ÿæ—¥å¿—
EOF

    echo "äº‹ä»¶æŠ¥å‘Šå·²åˆ›å»º: $report_file"
    echo "$report_file"
}

# ç´§æ€¥å“åº”æªæ–½
emergency_response() {
    local incident_id="$1"
    local action="$2"
    
    echo "æ‰§è¡Œç´§æ€¥å“åº”æªæ–½: $action"
    
    case "$action" in
        "isolate")
            isolate_system
            ;;
        "shutdown")
            emergency_shutdown
            ;;
        "block-ip")
            block_suspicious_ip "$3"
            ;;
        "backup")
            emergency_backup
            ;;
        "notify")
            notify_security_team "$incident_id"
            ;;
        *)
            echo "æœªçŸ¥çš„å“åº”æªæ–½: $action"
            return 1
            ;;
    esac
    
    # è®°å½•å“åº”åŠ¨ä½œ
    echo "[$(date -Iseconds)] æ‰§è¡Œå“åº”æªæ–½: $action" >> "$INCIDENT_DIR/$incident_id.log"
}

# éš”ç¦»ç³»ç»Ÿ
isolate_system() {
    echo "éš”ç¦»ç³»ç»Ÿ..."
    
    # æ–­å¼€ç½‘ç»œè¿æ¥ (ä¿ç•™ç®¡ç†è¿æ¥)
    iptables -I INPUT 1 -p tcp --dport 22 -s 10.0.0.0/8 -j ACCEPT
    iptables -I INPUT 2 -p tcp --dport 22 -s 172.16.0.0/12 -j ACCEPT
    iptables -I INPUT 3 -p tcp --dport 22 -s 192.168.0.0/16 -j ACCEPT
    iptables -I INPUT 4 -j DROP
    
    # åœæ­¢å¯¹å¤–æœåŠ¡
    docker compose stop nginx
    
    echo "ç³»ç»Ÿå·²éš”ç¦»ï¼Œä»…ä¿ç•™ç®¡ç†è¿æ¥"
}

# ç´§æ€¥å…³é—­
emergency_shutdown() {
    echo "æ‰§è¡Œç´§æ€¥å…³é—­..."
    
    # åˆ›å»ºå…³é—­æ—¥å¿—
    echo "[$(date -Iseconds)] ç´§æ€¥å…³é—­å¼€å§‹" >> "$INCIDENT_DIR/emergency_shutdown.log"
    
    # åœæ­¢æ‰€æœ‰æœåŠ¡
    docker compose down
    
    # æ–­å¼€ç½‘ç»œ
    iptables -P INPUT DROP
    iptables -P FORWARD DROP
    iptables -F
    
    echo "ç´§æ€¥å…³é—­å®Œæˆ"
}

# é˜»æ­¢å¯ç–‘IP
block_suspicious_ip() {
    local ip="$1"
    
    echo "é˜»æ­¢å¯ç–‘IP: $ip"
    
    # æ·»åŠ é˜²ç«å¢™è§„åˆ™
    iptables -I INPUT 1 -s "$ip" -j DROP
    
    # è®°å½•åˆ°æ—¥å¿—
    echo "[$(date -Iseconds)] é˜»æ­¢IP: $ip" >> "$INCIDENT_DIR/blocked_ips.log"
    
    # ä¿å­˜é˜²ç«å¢™è§„åˆ™
    iptables-save > /etc/iptables/rules.v4
    
    echo "IP $ip å·²è¢«é˜»æ­¢"
}

# ç´§æ€¥å¤‡ä»½
emergency_backup() {
    echo "æ‰§è¡Œç´§æ€¥å¤‡ä»½..."
    
    local backup_file="$INCIDENT_DIR/emergency_backup_$TIMESTAMP.tar.gz"
    
    # å¤‡ä»½å…³é”®æ•°æ®
    tar -czf "$backup_file" \
        config/ \
        data/ \
        logs/ \
        security/ \
        .env* \
        compose*.yml
    
    # è®¡ç®—æ ¡éªŒå’Œ
    sha256sum "$backup_file" > "$backup_file.sha256"
    
    echo "ç´§æ€¥å¤‡ä»½å®Œæˆ: $backup_file"
}

# é€šçŸ¥å®‰å…¨å›¢é˜Ÿ
notify_security_team() {
    local incident_id="$1"
    
    echo "é€šçŸ¥å®‰å…¨å›¢é˜Ÿ..."
    
    # å‘é€é‚®ä»¶é€šçŸ¥
    if [ -n "${SECURITY_EMAIL:-}" ]; then
        cat << EOF | mail -s "ğŸš¨ å®‰å…¨äº‹ä»¶æŠ¥å‘Š - $incident_id" "$SECURITY_EMAIL"
å®‰å…¨äº‹ä»¶æŠ¥å‘Š

äº‹ä»¶ID: $incident_id
å‘ç”Ÿæ—¶é—´: $(date)
æœåŠ¡å™¨: $(hostname)

è¯·ç«‹å³æŸ¥çœ‹äº‹ä»¶è¯¦æƒ…å¹¶é‡‡å–å¿…è¦æªæ–½ã€‚

äº‹ä»¶è¯¦æƒ…: $INCIDENT_DIR/$incident_id.md

-- 
Clash Docker å®‰å…¨ç›‘æ§ç³»ç»Ÿ
EOF
    fi
    
    # å‘é€Slacké€šçŸ¥
    if [ -n "${SLACK_WEBHOOK:-}" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{
                \"text\": \"ğŸš¨ å®‰å…¨äº‹ä»¶æŠ¥å‘Š\",
                \"attachments\": [{
                    \"color\": \"danger\",
                    \"fields\": [{
                        \"title\": \"äº‹ä»¶ID\",
                        \"value\": \"$incident_id\",
                        \"short\": true
                    }, {
                        \"title\": \"å‘ç”Ÿæ—¶é—´\",
                        \"value\": \"$(date)\",
                        \"short\": true
                    }, {
                        \"title\": \"æœåŠ¡å™¨\",
                        \"value\": \"$(hostname)\",
                        \"short\": true
                    }]
                }]
            }" \
            "$SLACK_WEBHOOK"
    fi
    
    echo "å®‰å…¨å›¢é˜Ÿé€šçŸ¥å·²å‘é€"
}

# æ”¶é›†æ•°å­—è¯æ®
collect_evidence() {
    local incident_id="$1"
    local evidence_dir="$INCIDENT_DIR/$incident_id-evidence"
    
    mkdir -p "$evidence_dir"
    
    echo "æ”¶é›†æ•°å­—è¯æ®..."
    
    # ç³»ç»Ÿä¿¡æ¯
    {
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        uname -a
        uptime
        date
        echo ""
        
        echo "=== ç½‘ç»œè¿æ¥ ==="
        netstat -an
        echo ""
        
        echo "=== è¿›ç¨‹åˆ—è¡¨ ==="
        ps aux
        echo ""
        
        echo "=== ç™»å½•ä¼šè¯ ==="
        who
        last -n 20
        echo ""
        
    } > "$evidence_dir/system_info.txt"
    
    # å®¹å™¨çŠ¶æ€
    docker ps -a > "$evidence_dir/container_status.txt"
    docker logs clash > "$evidence_dir/clash_logs.txt" 2>&1
    docker logs nginx > "$evidence_dir/nginx_logs.txt" 2>&1
    
    # ç½‘ç»œé…ç½®
    ip addr show > "$evidence_dir/network_config.txt"
    iptables -L -n > "$evidence_dir/firewall_rules.txt"
    
    # æ—¥å¿—æ–‡ä»¶
    cp -r logs/ "$evidence_dir/application_logs/" 2>/dev/null || true
    cp /var/log/auth.log "$evidence_dir/" 2>/dev/null || true
    cp /var/log/syslog "$evidence_dir/" 2>/dev/null || true
    
    # é…ç½®æ–‡ä»¶å¿«ç…§
    cp -r config/ "$evidence_dir/config_snapshot/" 2>/dev/null || true
    
    # è®¡ç®—è¯æ®å®Œæ•´æ€§
    find "$evidence_dir" -type f -exec sha256sum {} \; > "$evidence_dir/evidence_checksums.txt"
    
    echo "æ•°å­—è¯æ®æ”¶é›†å®Œæˆ: $evidence_dir"
}

# æ¢å¤ç³»ç»Ÿ
recover_system() {
    local incident_id="$1"
    local recovery_plan="$2"
    
    echo "å¼€å§‹ç³»ç»Ÿæ¢å¤..."
    
    case "$recovery_plan" in
        "restart")
            echo "é‡å¯æœåŠ¡..."
            docker compose up -d
            ;;
        "restore")
            echo "ä»å¤‡ä»½æ¢å¤..."
            local backup_file=$(ls -t "$INCIDENT_DIR"/emergency_backup_*.tar.gz | head -1)
            if [ -n "$backup_file" ]; then
                tar -xzf "$backup_file"
                docker compose up -d
            fi
            ;;
        "rebuild")
            echo "é‡å»ºç³»ç»Ÿ..."
            docker compose down
            docker system prune -f
            docker compose build --no-cache
            docker compose up -d
            ;;
        "manual")
            echo "éœ€è¦æ‰‹åŠ¨æ¢å¤ï¼Œè¯·å‚è€ƒæ¢å¤ç¨‹åºæ–‡æ¡£"
            ;;
        *)
            echo "æœªçŸ¥çš„æ¢å¤è®¡åˆ’: $recovery_plan"
            return 1
            ;;
    esac
    
    # éªŒè¯æ¢å¤
    sleep 30
    if ./scripts/health-check.sh; then
        echo "ç³»ç»Ÿæ¢å¤æˆåŠŸ"
        echo "[$(date -Iseconds)] ç³»ç»Ÿæ¢å¤æˆåŠŸ" >> "$INCIDENT_DIR/$incident_id.log"
    else
        echo "ç³»ç»Ÿæ¢å¤å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥å¤„ç†"
        echo "[$(date -Iseconds)] ç³»ç»Ÿæ¢å¤å¤±è´¥" >> "$INCIDENT_DIR/$incident_id.log"
        return 1
    fi
}

# äº‹ååˆ†æ
post_incident_analysis() {
    local incident_id="$1"
    
    echo "å¼€å§‹äº‹ååˆ†æ..."
    
    local analysis_file="$INCIDENT_DIR/$incident_id-analysis.md"
    
    cat > "$analysis_file" << EOF
# äº‹ååˆ†ææŠ¥å‘Š

**äº‹ä»¶ID**: $incident_id
**åˆ†ææ—¶é—´**: $(date -Iseconds)

## äº‹ä»¶æ€»ç»“

### äº‹ä»¶æ—¶é—´çº¿
[å¡«å†™è¯¦ç»†çš„äº‹ä»¶å‘ç”Ÿå’Œå“åº”æ—¶é—´çº¿]

### æ ¹æœ¬åŸå› 
[åˆ†æäº‹ä»¶çš„æ ¹æœ¬åŸå› ]

### å½±å“è¯„ä¼°
[è¯„ä¼°äº‹ä»¶å¯¹ç³»ç»Ÿã€æ•°æ®å’Œç”¨æˆ·çš„å½±å“]

## å“åº”æ•ˆæœè¯„ä¼°

### å“åº”æ—¶é—´
- å‘ç°æ—¶é—´: 
- å“åº”æ—¶é—´: 
- è§£å†³æ—¶é—´: 

### å“åº”æªæ–½æœ‰æ•ˆæ€§
[è¯„ä¼°å„é¡¹å“åº”æªæ–½çš„æœ‰æ•ˆæ€§]

## æ”¹è¿›å»ºè®®

### æŠ€æœ¯æ”¹è¿›
1. [æŠ€æœ¯å±‚é¢çš„æ”¹è¿›å»ºè®®]

### æµç¨‹æ”¹è¿›
1. [æµç¨‹å±‚é¢çš„æ”¹è¿›å»ºè®®]

### åŸ¹è®­éœ€æ±‚
1. [å›¢é˜ŸåŸ¹è®­éœ€æ±‚]

## åç»­è¡ŒåŠ¨è®¡åˆ’

- [ ] å®æ–½æŠ€æœ¯æ”¹è¿›
- [ ] æ›´æ–°å®‰å…¨ç­–ç•¥
- [ ] è¿›è¡Œå›¢é˜ŸåŸ¹è®­
- [ ] æ›´æ–°åº”æ€¥å“åº”ç¨‹åº

## ç»éªŒæ•™è®­

[æ€»ç»“æ­¤æ¬¡äº‹ä»¶çš„ç»éªŒæ•™è®­]

---
**åˆ†æäººå‘˜**: å®‰å…¨è¿ç»´å›¢é˜Ÿ
**å¤æ ¸äººå‘˜**: 
**æ‰¹å‡†äººå‘˜**: 
EOF

    echo "äº‹ååˆ†ææŠ¥å‘Šæ¨¡æ¿å·²åˆ›å»º: $analysis_file"
}

# äº¤äº’å¼äº‹ä»¶æŠ¥å‘Š
interactive_incident_report() {
    echo "=== å®‰å…¨äº‹ä»¶æŠ¥å‘Šç³»ç»Ÿ ==="
    echo ""
    
    # é€‰æ‹©äº‹ä»¶ç±»å‹
    echo "è¯·é€‰æ‹©äº‹ä»¶ç±»å‹:"
    for key in "${!INCIDENT_TYPES[@]}"; do
        echo "  $key. ${INCIDENT_TYPES[$key]}"
    done
    read -p "è¾“å…¥é€‰æ‹© (1-7): " incident_type
    
    if [[ ! "${INCIDENT_TYPES[$incident_type]:-}" ]]; then
        echo "æ— æ•ˆçš„äº‹ä»¶ç±»å‹"
        exit 1
    fi
    
    # é€‰æ‹©ä¸¥é‡æ€§çº§åˆ«
    echo ""
    echo "è¯·é€‰æ‹©ä¸¥é‡æ€§çº§åˆ«:"
    for key in "${!SEVERITY_LEVELS[@]}"; do
        echo "  $key. ${SEVERITY_LEVELS[$key]}"
    done
    read -p "è¾“å…¥é€‰æ‹© (1-4): " severity
    
    if [[ ! "${SEVERITY_LEVELS[$severity]:-}" ]]; then
        echo "æ— æ•ˆçš„ä¸¥é‡æ€§çº§åˆ«"
        exit 1
    fi
    
    # è¾“å…¥äº‹ä»¶æè¿°
    echo ""
    echo "è¯·æè¿°äº‹ä»¶è¯¦æƒ…:"
    read -p "æè¿°: " description
    
    # åˆ›å»ºäº‹ä»¶æŠ¥å‘Š
    local report_file=$(create_incident_report "$incident_type" "$severity" "$description")
    
    echo ""
    echo "äº‹ä»¶å·²è®°å½•: $INCIDENT_ID"
    echo "æŠ¥å‘Šæ–‡ä»¶: $report_file"
    
    # è¯¢é—®æ˜¯å¦éœ€è¦ç«‹å³å“åº”
    echo ""
    read -p "æ˜¯å¦éœ€è¦ç«‹å³æ‰§è¡Œå“åº”æªæ–½? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "å¯ç”¨çš„å“åº”æªæ–½:"
        echo "  1. isolate - éš”ç¦»ç³»ç»Ÿ"
        echo "  2. shutdown - ç´§æ€¥å…³é—­"
        echo "  3. block-ip - é˜»æ­¢IP"
        echo "  4. backup - ç´§æ€¥å¤‡ä»½"
        echo "  5. notify - é€šçŸ¥å›¢é˜Ÿ"
        
        read -p "é€‰æ‹©å“åº”æªæ–½: " response_action
        
        case "$response_action" in
            "1"|"isolate")
                emergency_response "$INCIDENT_ID" "isolate"
                ;;
            "2"|"shutdown")
                emergency_response "$INCIDENT_ID" "shutdown"
                ;;
            "3"|"block-ip")
                read -p "è¾“å…¥è¦é˜»æ­¢çš„IP: " suspicious_ip
                emergency_response "$INCIDENT_ID" "block-ip" "$suspicious_ip"
                ;;
            "4"|"backup")
                emergency_response "$INCIDENT_ID" "backup"
                ;;
            "5"|"notify")
                emergency_response "$INCIDENT_ID" "notify"
                ;;
            *)
                echo "æ— æ•ˆçš„å“åº”æªæ–½"
                ;;
        esac
    fi
    
    # è¯¢é—®æ˜¯å¦æ”¶é›†è¯æ®
    echo ""
    read -p "æ˜¯å¦ç«‹å³æ”¶é›†æ•°å­—è¯æ®? (Y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        collect_evidence "$INCIDENT_ID"
    fi
}

# ä¸»ç¨‹åº
main() {
    local action="${1:-interactive}"
    
    case "$action" in
        "interactive"|"report")
            interactive_incident_report
            ;;
        "emergency")
            emergency_response "$2" "$3" "$4"
            ;;
        "collect")
            collect_evidence "$2"
            ;;
        "recover")
            recover_system "$2" "$3"
            ;;
        "analyze")
            post_incident_analysis "$2"
            ;;
        *)
            echo "ç”¨æ³•: $0 {interactive|emergency|collect|recover|analyze} [å‚æ•°...]"
            echo ""
            echo "å‘½ä»¤:"
            echo "  interactive                           - äº¤äº’å¼äº‹ä»¶æŠ¥å‘Š"
            echo "  emergency <incident_id> <action>     - ç´§æ€¥å“åº”"
            echo "  collect <incident_id>                - æ”¶é›†è¯æ®"
            echo "  recover <incident_id> <plan>         - ç³»ç»Ÿæ¢å¤"
            echo "  analyze <incident_id>                - äº‹ååˆ†æ"
            ;;
    esac
}

main "$@"
```

## å®‰å…¨æœ€ä½³å®è·µ

### å®šæœŸå®‰å…¨ç»´æŠ¤

åˆ›å»º `security/security-maintenance.sh`:
```bash
#!/bin/bash
# å®šæœŸå®‰å…¨ç»´æŠ¤è„šæœ¬

set -euo pipefail

MAINTENANCE_LOG="security/maintenance.log"

log_maintenance() {
    echo "[$(date -Iseconds)] $*" | tee -a "$MAINTENANCE_LOG"
}

# æ¯æ—¥å®‰å…¨ç»´æŠ¤
daily_maintenance() {
    log_maintenance "å¼€å§‹æ¯æ—¥å®‰å…¨ç»´æŠ¤"
    
    # æ›´æ–°å¨èƒæƒ…æŠ¥
    update_threat_intelligence
    
    # æ£€æŸ¥å®‰å…¨æ›´æ–°
    check_security_updates
    
    # è½®æ¢ä¸´æ—¶å¯†é’¥
    rotate_temporary_keys
    
    # æ¸…ç†è¿‡æœŸæ—¥å¿—
    cleanup_expired_logs
    
    log_maintenance "æ¯æ—¥å®‰å…¨ç»´æŠ¤å®Œæˆ"
}

# æ¯å‘¨å®‰å…¨ç»´æŠ¤
weekly_maintenance() {
    log_maintenance "å¼€å§‹æ¯å‘¨å®‰å…¨ç»´æŠ¤"
    
    # å®‰å…¨æ‰«æ
    ./security/vulnerability-scan.sh
    
    # æ›´æ–°å®‰å…¨è§„åˆ™
    update_security_rules
    
    # å¯†é’¥å¥åº·æ£€æŸ¥
    verify_key_health
    
    # ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
    generate_weekly_security_report
    
    log_maintenance "æ¯å‘¨å®‰å…¨ç»´æŠ¤å®Œæˆ"
}

# æ¯æœˆå®‰å…¨ç»´æŠ¤
monthly_maintenance() {
    log_maintenance "å¼€å§‹æ¯æœˆå®‰å…¨ç»´æŠ¤"
    
    # å¯†é’¥è½®æ¢
    ./security/key-management.sh rotate clash-service
    
    # è¯ä¹¦æ£€æŸ¥
    check_certificate_expiry
    
    # å®‰å…¨ç­–ç•¥å®¡æŸ¥
    review_security_policies
    
    # å®‰å…¨åŸ¹è®­è¯„ä¼°
    assess_security_training
    
    log_maintenance "æ¯æœˆå®‰å…¨ç»´æŠ¤å®Œæˆ"
}

# æ›´æ–°å¨èƒæƒ…æŠ¥
update_threat_intelligence() {
    log_maintenance "æ›´æ–°å¨èƒæƒ…æŠ¥"
    
    local threat_db="security/threat-indicators.json"
    local temp_file="/tmp/threat_update.json"
    
    # ä»å¨èƒæƒ…æŠ¥æºè·å–æœ€æ–°æ•°æ®
    # è¿™é‡Œä½¿ç”¨ç¤ºä¾‹æºï¼Œå®é™…åº”æ›¿æ¢ä¸ºçœŸå®çš„å¨èƒæƒ…æŠ¥API
    if curl -s "https://example-threat-intel.com/api/latest" > "$temp_file"; then
        if jq empty "$temp_file" 2>/dev/null; then
            mv "$temp_file" "$threat_db"
            log_maintenance "å¨èƒæƒ…æŠ¥æ›´æ–°æˆåŠŸ"
        else
            log_maintenance "å¨èƒæƒ…æŠ¥æ ¼å¼æ— æ•ˆ"
        fi
    else
        log_maintenance "å¨èƒæƒ…æŠ¥è·å–å¤±è´¥"
    fi
}

# æ£€æŸ¥å®‰å…¨æ›´æ–°
check_security_updates() {
    log_maintenance "æ£€æŸ¥å®‰å…¨æ›´æ–°"
    
    # æ£€æŸ¥ç³»ç»Ÿæ›´æ–°
    if command -v apt >/dev/null; then
        apt list --upgradable 2>/dev/null | grep -i security || log_maintenance "æ— å®‰å…¨æ›´æ–°"
    elif command -v yum >/dev/null; then
        yum check-update --security || log_maintenance "æ— å®‰å…¨æ›´æ–°"
    fi
    
    # æ£€æŸ¥Dockeré•œåƒæ›´æ–°
    docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.CreatedAt}}" | grep -E "(clash|nginx)" | while read repo tag created; do
        # æ£€æŸ¥é•œåƒæ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
        latest_tag=$(docker search "$repo" --limit 1 --format "{{.Name}}" 2>/dev/null | head -1)
        if [ -n "$latest_tag" ]; then
            log_maintenance "æ£€æŸ¥é•œåƒæ›´æ–°: $repo:$tag"
        fi
    done
}

# è½®æ¢ä¸´æ—¶å¯†é’¥
rotate_temporary_keys() {
    log_maintenance "è½®æ¢ä¸´æ—¶å¯†é’¥"
    
    # ç”Ÿæˆæ–°çš„ä¼šè¯å¯†é’¥
    local session_key=$(openssl rand -hex 32)
    echo "$session_key" > security/session.key
    chmod 600 security/session.key
    
    # æ›´æ–°APIå¯†é’¥ (å¦‚æœéœ€è¦)
    local current_hour=$(date +%H)
    if [ "$current_hour" = "00" ]; then
        ./security/api-key-auth.sh generate "daily-$(date +%Y%m%d)"
    fi
}

# æ¸…ç†è¿‡æœŸæ—¥å¿—
cleanup_expired_logs() {
    log_maintenance "æ¸…ç†è¿‡æœŸæ—¥å¿—"
    
    # æ¸…ç†è¶…è¿‡30å¤©çš„æ—¥å¿—
    find logs/ -name "*.log" -mtime +30 -delete 2>/dev/null || true
    find security/scan-results/ -name "*.txt" -mtime +7 -delete 2>/dev/null || true
    find security/incidents/ -name "*.log" -mtime +90 -delete 2>/dev/null || true
    
    log_maintenance "è¿‡æœŸæ—¥å¿—æ¸…ç†å®Œæˆ"
}

# æ›´æ–°å®‰å…¨è§„åˆ™
update_security_rules() {
    log_maintenance "æ›´æ–°å®‰å…¨è§„åˆ™"
    
    # æ›´æ–°é˜²ç«å¢™è§„åˆ™
    ./security/firewall-rules.sh
    
    # æ›´æ–°Nginxå®‰å…¨é…ç½®
    nginx -t && nginx -s reload || log_maintenance "Nginxé…ç½®éªŒè¯å¤±è´¥"
    
    log_maintenance "å®‰å…¨è§„åˆ™æ›´æ–°å®Œæˆ"
}

# éªŒè¯å¯†é’¥å¥åº·
verify_key_health() {
    log_maintenance "éªŒè¯å¯†é’¥å¥åº·"
    
    local keystore_dir="security/keystore"
    if [ -d "$keystore_dir" ]; then
        for key_file in "$keystore_dir"/*.key; do
            if [ -f "$key_file" ]; then
                local service_name=$(basename "$key_file" .key)
                if ./security/key-management.sh verify "$service_name"; then
                    log_maintenance "å¯†é’¥å¥åº·: $service_name âœ“"
                else
                    log_maintenance "å¯†é’¥å¼‚å¸¸: $service_name âœ—"
                fi
            fi
        done
    fi
}

# æ£€æŸ¥è¯ä¹¦è¿‡æœŸ
check_certificate_expiry() {
    log_maintenance "æ£€æŸ¥è¯ä¹¦è¿‡æœŸ"
    
    local cert_dir="security/certs"
    if [ -d "$cert_dir" ]; then
        for cert_file in "$cert_dir"/*.crt; do
            if [ -f "$cert_file" ]; then
                local expiry_date=$(openssl x509 -in "$cert_file" -noout -enddate | cut -d= -f2)
                local expiry_epoch=$(date -d "$expiry_date" +%s)
                local current_epoch=$(date +%s)
                local days_left=$(( (expiry_epoch - current_epoch) / 86400 ))
                
                if [ "$days_left" -lt 30 ]; then
                    log_maintenance "è¯ä¹¦å³å°†è¿‡æœŸ: $cert_file (å‰©ä½™ $days_left å¤©)"
                else
                    log_maintenance "è¯ä¹¦æœ‰æ•ˆ: $cert_file (å‰©ä½™ $days_left å¤©)"
                fi
            fi
        done
    fi
}

# ç”Ÿæˆæ¯å‘¨å®‰å…¨æŠ¥å‘Š
generate_weekly_security_report() {
    log_maintenance "ç”Ÿæˆæ¯å‘¨å®‰å…¨æŠ¥å‘Š"
    
    local report_file="security/weekly-report-$(date +%Y%W).md"
    
    cat > "$report_file" << EOF
# æ¯å‘¨å®‰å…¨æŠ¥å‘Š

**æŠ¥å‘Šå‘¨æœŸ**: $(date -d 'last monday' +%Y-%m-%d) è‡³ $(date +%Y-%m-%d)
**ç”Ÿæˆæ—¶é—´**: $(date -Iseconds)

## å®‰å…¨äº‹ä»¶ç»Ÿè®¡

### å®‰å…¨å‘Šè­¦
$(grep -c "Security Alert" security/security-alerts.log 2>/dev/null || echo "0") æ¡

### è®¤è¯å¤±è´¥
$(grep -c "è®¤è¯å¤±è´¥" security/security-alerts.log 2>/dev/null || echo "0") æ¬¡

### ç½‘ç»œå¼‚å¸¸
$(grep -c "å¼‚å¸¸è¿æ¥" security/security-alerts.log 2>/dev/null || echo "0") æ¬¡

## æ¼æ´æ‰«æç»“æœ

### å‘ç°çš„æ¼æ´
$(find security/scan-results/ -name "*vuln*" -mtime -7 | wc -l) ä¸ªæ‰«ææ–‡ä»¶

### é«˜é£é™©é—®é¢˜
å¾…æ‰‹åŠ¨åˆ†æ

## ç³»ç»Ÿå®‰å…¨çŠ¶æ€

### å®¹å™¨å®‰å…¨
- érootè¿è¡Œ: $(docker ps --format "{{.Names}}" | xargs -I {} docker exec {} whoami | grep -v root | wc -l) / $(docker ps -q | wc -l)
- èµ„æºé™åˆ¶: å·²é…ç½®

### ç½‘ç»œå®‰å…¨
- é˜²ç«å¢™çŠ¶æ€: $(ufw status | head -1)
- å¼€æ”¾ç«¯å£: $(netstat -tlnp | grep LISTEN | wc -l)

## æ”¹è¿›å»ºè®®

1. å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–
2. åŠ å¼ºæ—¥å¿—ç›‘æ§
3. å®æ–½æ›´é¢‘ç¹çš„å®‰å…¨æ‰«æ

---
**æŠ¥å‘Šç”Ÿæˆ**: è‡ªåŠ¨åŒ–å®‰å…¨ç»´æŠ¤ç³»ç»Ÿ
EOF

    log_maintenance "æ¯å‘¨å®‰å…¨æŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
}

# ä¸»ç»´æŠ¤æµç¨‹
main() {
    local maintenance_type="${1:-daily}"
    
    case "$maintenance_type" in
        "daily")
            daily_maintenance
            ;;
        "weekly")
            weekly_maintenance
            ;;
        "monthly")
            monthly_maintenance
            ;;
        "all")
            daily_maintenance
            weekly_maintenance
            monthly_maintenance
            ;;
        *)
            echo "ç”¨æ³•: $0 {daily|weekly|monthly|all}"
            echo ""
            echo "ç»´æŠ¤ç±»å‹:"
            echo "  daily   - æ¯æ—¥å®‰å…¨ç»´æŠ¤"
            echo "  weekly  - æ¯å‘¨å®‰å…¨ç»´æŠ¤"
            echo "  monthly - æ¯æœˆå®‰å…¨ç»´æŠ¤"
            echo "  all     - æ‰§è¡Œæ‰€æœ‰ç»´æŠ¤ä»»åŠ¡"
            ;;
    esac
}

main "$@"
```

### å®‰å…¨æ£€æŸ¥æ¸…å•

åˆ›å»º `security/security-checklist.md`:
```markdown
# ğŸ” å®‰å…¨æ£€æŸ¥æ¸…å•

## éƒ¨ç½²å‰å®‰å…¨æ£€æŸ¥

### å®¹å™¨å®‰å…¨
- [ ] ä½¿ç”¨érootç”¨æˆ·è¿è¡Œå®¹å™¨
- [ ] é…ç½®åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
- [ ] ç§»é™¤ä¸å¿…è¦çš„Linux capabilities
- [ ] è®¾ç½®èµ„æºé™åˆ¶ (CPU/å†…å­˜)
- [ ] å¯ç”¨å®‰å…¨é€‰é¡¹ (no-new-privileges)
- [ ] é…ç½®å¥åº·æ£€æŸ¥
- [ ] ä½¿ç”¨æœ€æ–°çš„åŸºç¡€é•œåƒ

### ç½‘ç»œå®‰å…¨
- [ ] é…ç½®é˜²ç«å¢™è§„åˆ™
- [ ] é™åˆ¶ç«¯å£ç»‘å®š (ä»…localhost)
- [ ] é…ç½®ç½‘ç»œéš”ç¦»
- [ ] å¯ç”¨DDoSé˜²æŠ¤
- [ ] é…ç½®SSL/TLS
- [ ] è®¾ç½®å®‰å…¨å“åº”å¤´

### è®¿é—®æ§åˆ¶
- [ ] å¯ç”¨HTTPåŸºæœ¬è®¤è¯
- [ ] é…ç½®IPç™½åå•
- [ ] è®¾ç½®APIå¯†é’¥è®¤è¯
- [ ] é…ç½®ä¼šè¯è¶…æ—¶
- [ ] å®æ–½æœ€å°æƒé™åŸåˆ™

### æ•°æ®ä¿æŠ¤
- [ ] åŠ å¯†æ•æ„Ÿé…ç½®æ–‡ä»¶
- [ ] å®‰å…¨å­˜å‚¨å¯†é’¥
- [ ] é…ç½®æ•°æ®å¤‡ä»½
- [ ] è®¾ç½®æ—¥å¿—è½®è½¬
- [ ] å®æ–½æ•°æ®åˆ†ç±»

## è¿è¡Œæ—¶å®‰å…¨æ£€æŸ¥

### ç›‘æ§å’Œå‘Šè­¦
- [ ] é…ç½®å®‰å…¨äº‹ä»¶ç›‘æ§
- [ ] è®¾ç½®å¼‚å¸¸è¡Œä¸ºå‘Šè­¦
- [ ] å¯ç”¨å®¡è®¡æ—¥å¿—
- [ ] é…ç½®æ—¥å¿—èšåˆ
- [ ] è®¾ç½®å‘Šè­¦é€šçŸ¥

### æ¼æ´ç®¡ç†
- [ ] å®šæœŸå®‰å…¨æ‰«æ
- [ ] ç›‘æ§å®‰å…¨å…¬å‘Š
- [ ] åŠæ—¶åº”ç”¨è¡¥ä¸
- [ ] éªŒè¯ä¿®å¤æ•ˆæœ
- [ ] æ›´æ–°å¨èƒæƒ…æŠ¥

### äº‹ä»¶å“åº”
- [ ] åˆ¶å®šå“åº”æµç¨‹
- [ ] å‡†å¤‡åº”æ€¥å·¥å…·
- [ ] å®šæœŸæ¼”ç»ƒ
- [ ] å»ºç«‹é€šä¿¡æœºåˆ¶
- [ ] å‡†å¤‡æ¢å¤è®¡åˆ’

## å®šæœŸç»´æŠ¤æ£€æŸ¥

### æ¯æ—¥æ£€æŸ¥
- [ ] æŸ¥çœ‹å®‰å…¨å‘Šè­¦
- [ ] æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—
- [ ] éªŒè¯æœåŠ¡çŠ¶æ€
- [ ] æ›´æ–°å¨èƒæƒ…æŠ¥
- [ ] è½®æ¢ä¸´æ—¶å¯†é’¥

### æ¯å‘¨æ£€æŸ¥
- [ ] æ‰§è¡Œå®‰å…¨æ‰«æ
- [ ] å®¡æŸ¥è®¿é—®æ—¥å¿—
- [ ] æ›´æ–°å®‰å…¨è§„åˆ™
- [ ] ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
- [ ] éªŒè¯å¤‡ä»½å®Œæ•´æ€§

### æ¯æœˆæ£€æŸ¥
- [ ] è½®æ¢é•¿æœŸå¯†é’¥
- [ ] æ£€æŸ¥è¯ä¹¦è¿‡æœŸ
- [ ] å®¡æŸ¥å®‰å…¨ç­–ç•¥
- [ ] æ›´æ–°å®‰å…¨æ–‡æ¡£
- [ ] è¿›è¡Œå®‰å…¨åŸ¹è®­

## åˆè§„æ€§æ£€æŸ¥

### æ•°æ®ä¿æŠ¤
- [ ] ä¸ªäººä¿¡æ¯åŠ å¯†
- [ ] æ•°æ®æœ€å°åŒ–åŸåˆ™
- [ ] è®¿é—®æ—¥å¿—è®°å½•
- [ ] æ•°æ®ä¿ç•™ç­–ç•¥
- [ ] åˆ é™¤ç¡®è®¤æœºåˆ¶

### å®¡è®¡è¦æ±‚
- [ ] å®Œæ•´çš„å®¡è®¡è·Ÿè¸ª
- [ ] ä¸å¯ç¯¡æ”¹çš„æ—¥å¿—
- [ ] å®šæœŸå®¡è®¡æŠ¥å‘Š
- [ ] ç¬¬ä¸‰æ–¹è¯„ä¼°
- [ ] åˆè§„æ€§è¯æ˜

### é£é™©ç®¡ç†
- [ ] é£é™©è¯„ä¼°æŠ¥å‘Š
- [ ] å¨èƒæ¨¡å‹åˆ†æ
- [ ] ä¸šåŠ¡å½±å“åˆ†æ
- [ ] åº”æ€¥å“åº”è®¡åˆ’
- [ ] æŒç»­æ”¹è¿›æœºåˆ¶
```

**é‡è¦æé†’**: 
- å®‰å…¨æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦å®šæœŸè¯„ä¼°å’Œæ”¹è¿›
- æ‰€æœ‰å®‰å…¨æªæ–½éƒ½åº”è¯¥æ ¹æ®å®é™…å¨èƒç¯å¢ƒè¿›è¡Œè°ƒæ•´
- å»ºè®®å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡å’Œæ¸—é€æµ‹è¯•
- ä¿æŒå¯¹æœ€æ–°å®‰å…¨å¨èƒå’Œé˜²æŠ¤æŠ€æœ¯çš„å…³æ³¨

---

**æ›´æ–°æ—¥æœŸ**: 2025-07-13  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**ç»´æŠ¤è€…**: å®‰å…¨å›¢é˜Ÿ